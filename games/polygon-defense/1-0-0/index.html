<!DOCTYPE HTML>
<html>
    <body>
        <style>
            @font-face {
                font-family: kdamthmorepro;
                src: url(kdamthmorepro.ttf);
            }
            canvas {
                background-color: white;
                margin: auto;
                margin: 0;
                position: absolute;
                top: 50%;
                left: 50%;
                -ms-transform: translate(-50%,-50%);
                transform: translate(-50%,-50%);
            }
            body {
                background-color: rgb(50,50,50);
                margin: 0px;
                font-family: 'Kdam Thmor Pro', sans-serif;
                color: white;
            }
        </style>
        <canvas id='canvas'></canvas>
        <script>
            var title = 'Polygon Defense';
            var dimensions = {width:1000,height:1000};
            var imgs = [];
            var audios = [];
            var canvas = document.getElementById('canvas');
            var ratio = dimensions.width/dimensions.height;
            var sizeText = 'min(100vw,100vh)';
            if(ratio>1) {
                sizeText = 'min('+(100/ratio)+'vw,100vh)';
                canvas.style.width = 'calc('+sizeText+' * '+ratio+')';
                canvas.style.height = sizeText;
            } else if(ratio<1) {
                sizeText = 'min(100vw,'+(100*ratio)+'vh)';
                canvas.style.width = sizeText;
                canvas.style.height = 'calc('+sizeText+' * '+(1/ratio)+')';
            } else {
                canvas.style.width = sizeText;
                canvas.style.height = sizeText;
            }
            canvas.width = dimensions.width;
            canvas.height = dimensions.height;
            document.title = title;
            var ctx = canvas.getContext('2d');
            canvas.onmousemove = function(event) {
                var rect = canvas.getBoundingClientRect();
                Mouse.x = (event.pageX-rect.x)*canvas.width/rect.width;
                Mouse.y = (event.pageY-rect.y)*canvas.height/rect.height;
            }
            canvas.onclick = function(event) {
                Mouse.click = true;
            }
            canvas.onmousedown = function(event) {
                Mouse.down = true;
            }
            canvas.onmouseup = function(event) {
                Mouse.down = false;
            }
            canvas.oncontextmenu = function(event) {
                event.preventDefault();
                Mouse.rightClick = true;
            }
            window.onkeydown = function(event) {
                Keys.keys[event.keyCode] = true;
                Keys.down[event.keyCode] = true;
                word += String.fromCharCode(event.keyCode);
            }
            window.onkeyup = function(event) {
                Keys.keys[event.keyCode] = false;
                Keys.up[event.keyCode] = true;
            }
            canvas.onwheel = function(event) {
                Mouse.scrollX = event.deltaX;
                Mouse.scrollY = event.deltaY;
                event.preventDefault();
            }
            var loads = 0;
            var loaded = false;
            var intro = 300;
            var word = '';
            var n = 0;
            while(n < imgs.length) {
                var img = document.createElement('IMG');
                img.src = "https://johnbutlergames.w3spaces.com/game-images/"+imgs[n];
                imgs[n] = img;
                img.onload = function() {
                    loads++;
                }
                n++;
            }
            var n = 0;
            while(n < audios.length) {
                var aud = document.createElement('AUDIO');
                aud.src = audios[n];
                audios[n] = aud;
                aud.oncanplaythrough = function() {
                    loads++;
                }
                n++;
            }
            var logoImg = document.createElement("img");
            logoImg.src = "https://johnbutlergames.w3spaces.com/logoLarge.png";
            logoImg.onload = function() {
                loads++;
            }
            var loadAnimation = 0;
            var Mouse = {
                x: 0,
                y: 0,
                down: false,
                click: false,
                rightClick: false,
                scrollX: 0,
                scrollY: 0,
                inBox: function(x,y,w,h) {
                    return this.x>x&&this.x<x+w&&this.y>y&&this.y<y+h;
                },
                clickInBox: function(x,y,w,h) {
                    return this.inBox(x,y,w,h)&&this.click;
                }
            }
            var Keys = {
                keys: [],
                down: [],
                up: []
            }
            function roundRect(x, y, w, h, r) {
                ctx.beginPath();
                ctx.moveTo(x+r,y);
                ctx.lineTo(x+w-r,y);
                ctx.lineTo(x+w,y+r);
                ctx.lineTo(x+w,y+h-r);
                ctx.lineTo(x+w-r,y+h);
                ctx.lineTo(x+r,y+h);
                ctx.lineTo(x,y+h-r);
                ctx.lineTo(x,y+r);
                ctx.closePath();
            }
            function rotate(cx, cy, x, y, angle) {
                var radians = (Math.PI / 180) * angle,
                    cos = Math.cos(radians),
                    sin = Math.sin(radians),
                    nx = (cos * (x - cx)) + (sin * (y - cy)) + cx,
                    ny = (cos * (y - cy)) - (sin * (x - cx)) + cy;
                return [nx, ny];
            }
            function dirTo(x1,y1,x2,y2) {
                return 90+(Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI);
            }
            function distToMove(distance,direction) {
                return [distance*Math.sin(direction*Math.PI/180),-distance*Math.cos(direction*Math.PI/180)];
            }
            function distTo(x1,y1,x2,y2) {
                return Math.sqrt(Math.pow(x1-x2,2)+Math.pow(y1-y2,2));
            }
            function f(s) {
                ctx.font = s+"px kdamthmorepro";
            }
            function drawPolygon(x,y,s,r,a) {
                ctx.beginPath();
                ctx.save();
                ctx.translate(x,y);
                ctx.rotate(a*Math.PI/180);
                ctx.moveTo(0,-r);
                var n = 1;
                while(n < s) {
                    ctx.rotate(Math.PI*2/s);
                    ctx.lineTo(0,-r);
                    n++;
                }
                ctx.closePath();
                ctx.restore();
            }
            function rotate(cx, cy, x, y, angle) {
                var radians = (Math.PI / 180) * angle,
                    cos = Math.cos(radians),
                    sin = Math.sin(radians),
                    nx = (cos * (x - cx)) + (sin * (y - cy)) + cx,
                    ny = (cos * (y - cy)) - (sin * (x - cx)) + cy;
                return [nx, ny];
            }
            function turn(angle,targetAngle) {
                angle %= 360;
                targetAngle %= 360;
                if(angle<0) {
                    angle += 360;
                }
                if(targetAngle<0) {
                    targetAngle += 360;
                }
                var turnRight = targetAngle-angle;
                var turnLeft = targetAngle-angle;
                if(turnRight<0) {
                    turnLeft += 360;
                } else {
                    turnLeft -= 360;
                }
                if(Math.abs(turnRight)<Math.abs(turnLeft)) {
                    return turnRight;
                } else {
                    return turnLeft;
                }
            }
            function s(n) {
                if(n>0) {
                    return 1;
                } else if(n<0) {
                    return -1;
                } else {
                    return 0;
                }
            }
            function update() {
                ctx.clearRect(0,0,canvas.width,canvas.height);
                var s = Math.min(dimensions.width,dimensions.height);
                var x = (dimensions.width-s);
                var y = (dimensions.height-s);
                if(loaded) {
                    if(intro) {
                        intro-=2;
                        ctx.globalAlpha = 1-Math.min(Math.max(Math.abs(intro-150)-50,0),100)/100;
                        ctx.save();
                        ctx.scale(s/1000,s/1000);
                        ctx.translate(x,y);
                        ctx.drawImage(logoImg,0,0,1000,1000);
                        ctx.restore();
                        ctx.globalAlpha = 1;
                    } else {
                        main();
                    }
                } else {
                    var percent = loads/(imgs.length+audios.length+1);
                    if(isNaN(percent)) {
                        percent = 1;
                    }
                    if(percent===1) {
                        loaded = true;
                    }
                    ctx.save();
                    ctx.scale(s/1000,s/1000);
                    ctx.translate(x,y);
                    ctx.textAlign = 'center';
                    ctx.font = '60px Arial';
                    ctx.fillStyle = 'black';
                    ctx.fillRect(90,540,820,30);
                    ctx.fillStyle = 'blue';
                    ctx.fillRect(95,545,810*percent,20);
                    ctx.beginPath();
                    ctx.rect(95,545,810*percent,20);
                    ctx.save();
                    ctx.clip();
                    ctx.fillStyle = 'rgb(255,100,0)';
                    var a = loadAnimation%80;
                    var n = 0;
                    while(n < 40) {
                        ctx.beginPath();
                        ctx.moveTo(n*40+a+10,545);
                        ctx.lineTo(n*40+a+25,545);
                        ctx.lineTo(n*40+a+15,565);
                        ctx.lineTo(n*40+a,565);
                        ctx.closePath();
                        ctx.fill();
                        n++;
                    }
                    ctx.restore();
                    ctx.fillStyle = 'black';
                    ctx.fillText('Loading...',500,500);
                    ctx.restore();
                    loadAnimation++;
                }
                Mouse.click = false;
                Mouse.rightClick = false;
                Mouse.scrollX = 0;
                Mouse.scrollY = 0;
                Keys.down = [];
                Keys.up = [];
            }
            window.setInterval(update,10);

            function main() {
                if(page=='menu') {
                    menu.update();
                } else {
                    game.tick();
                }
                t++;
            }

            var menu = {
                page: 'home',
                switchPage: 'home',
                switchPageAnimation: 0,
                update: function() {
                    this.polygons.update();
                    this.polygons.draw();
                    if(this.switchPage!==this.page) {
                        if(this.switchPageAnimation==0) {
                            this.switchPageAnimation = 1;
                        }
                        this.switchPageAnimation++;
                        if(this.switchPageAnimation==100) {
                            this.page = this.switchPage;
                        }
                        this.drawPage(this.page,false);
                    } else {
                        if(this.switchPageAnimation>0) {
                            this.switchPageAnimation--;
                        }
                        this.drawPage(this.page,true);
                    }
                    ctx.globalAlpha = this.switchPageAnimation/100;
                    ctx.fillStyle = 'black';
                    ctx.fillRect(0,0,1000,1000);
                    ctx.globalAlpha = 1;
                },
                drawPage: function(p,canClick) {
                    if(p=='home') {
                        f(90);
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillStyle = 'rgba(200,200,200,0.5)';
                        ctx.fillRect(0,80,1000,120);
                        ctx.fillStyle = 'black';
                        ctx.fillText('Polygon Defense',500,150);

                        f(70);
                        ctx.strokeStyle = 'black';
                        ctx.lineWidth = 5;
                        ctx.fillStyle = 'rgb(255,255,255)';
                        roundRect(350,320,300,120,20);
                        if(Mouse.inBox(350,320,300,120)&&canClick) {
                            ctx.fillStyle = 'rgb(230,230,230)';
                            if(Mouse.click) {
                                game.reset();
                                this.switchPage = 'game';
                            }
                        }
                        ctx.fill();
                        ctx.stroke();
                        ctx.fillStyle = 'black';
                        ctx.fillText('Play',500,390);
                        //play button

                        ctx.fillStyle = 'rgb(255,255,255)';
                        roundRect(300,520,400,120,20);
                        if(Mouse.inBox(300,520,400,120)&&canClick) {
                            ctx.fillStyle = 'rgb(230,230,230)';
                            if(Mouse.click) {
                                this.switchPage = 'credits';
                            } 
                        }
                        ctx.fill();
                        ctx.stroke();
                        ctx.fillStyle = 'black';
                        ctx.fillText('Credits',500,590);
                        //credits button

                        ctx.fillStyle = 'rgba(200,200,200,0.5)';
                        ctx.fillRect(0,740,1000,100);
                        ctx.fillStyle = 'black';
                        ctx.fillText('Highscore: '+highscore,500,800);
                        //highscore
                    } else if(p=='credits') {
                        f(90);
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillStyle = 'rgba(200,200,200,0.5)';
                        ctx.fillRect(0,80,1000,120);
                        ctx.fillRect(0,240,1000,210);
                        ctx.fillStyle = 'black';
                        ctx.fillText('Credits:',500,150);
                        //title

                        f(60);
                        ctx.fillText('Game Design: John Butler',500,300);
                        ctx.fillText('Programming: John Butler',500,400);
                        //credits

                        f(70);
                        ctx.strokeStyle = 'black';
                        ctx.lineWidth = 5;
                        ctx.fillStyle = 'rgb(255,255,255)';
                        if(Mouse.inBox(350,820,300,120)&&canClick) {
                            ctx.fillStyle = 'rgb(230,230,230)';
                            if(Mouse.click) {
                                this.switchPage = 'home';
                            }
                        }
                        roundRect(350,820,300,120,20);
                        ctx.fill();
                        ctx.stroke();
                        ctx.fillStyle = 'black';
                        ctx.fillText('Back',500,890);
                        //back button
                    } else if(p=='game') {
                        if(canClick) {
                            page = 'game';
                            game.startAnimation = 100;
                            this.page = "home";
                            this.switchPage = "home";
                            this.switchPageAnimation = 100;
                        }
                    }
                },
                polygons: {
                    polygons: [],
                    update: function() {
                        var n = 0;
                        while(n < this.polygons.length) {
                            var p = this.polygons[n];
                            p.x += p.xmove;
                            p.y += p.ymove;
                            p.angle += p.rotate;
                            if(p.x<-100) {
                                p.x += 1200;
                            }
                            if(p.y<-100) {
                                p.y += 1200;
                            }
                            if(p.x>1100) {
                                p.x -= 1200;
                            }
                            if(p.y>1100) {
                                p.y -= 1200;
                            }
                            n++;
                        }
                    },
                    draw: function() {
                        var n = 0;
                        while(n < this.polygons.length) {
                            var p = this.polygons[n];
                            ctx.lineWidth = 5;
                            ctx.strokeStyle = p.color;
                            drawPolygon(p.x,p.y,p.s,p.r,p.angle);
                            ctx.stroke();
                            n++;
                        }
                    },
                    reset: function() {
                        this.polygons = [];
                        var n = 0;
                        while(n < 30) {
                            var p = {};
                            p.color = 'hsl('+(Math.random()*360)+',100%,50%)';
                            p.s = 3+Math.floor(Math.random()*4);
                            p.r = 25+Math.random()*30;
                            p.x = Math.random()*1000;
                            p.y = Math.random()*1000;
                            var dir = Math.random()*360;
                            var move = distToMove(Math.random()/2+0.5,dir);
                            p.xmove = move[0];
                            p.ymove = move[1];
                            p.angle = Math.random()*360;
                            p.rotate = Math.random()*3-1.5;
                            this.polygons.push(p);
                            n++;
                        }
                    }
                }
            }

            var game = {
                tick: function() {
                    if(this.startAnimation==0&&!this.paused) this.update();
                    this.draw();
                    if(this.paused) this.updatePauseMenu();

                    if(this.startAnimation>0) this.startAnimation--;
                },
                update: function() {
                    if(this.gameOver) this.ui.objectSelectedId = false;
                    if(!this.gameOver) this.ui.update();
                    this.objects.update(this.speed);
                    this.deletedObjects.update();
                    if(!this.gameOver) {
                        this.waves.update();
                        this.cam.update();
                    }

                    if(!this.objects.getObjectById('base1')&&!this.gameOver) {
                        this.gameOver = true;
                        this.gameOverAnimation = 100;
                        highscore = Math.max(highscore,this.score);
                        updateHighscore();
                    }

                    if(this.gameOver) this.updateGameOverMenu();


                    this.totalTowerWorth = 0;
                    for(var o of this.objects.objects) {
                        if(o.type!="tower") continue;
                        this.totalTowerWorth += this.ui.getTotalTowerCost(o);
                    }

                    this.score = Math.max(0,this.waves.wave-1)*50;
                    this.score += this.money-10;
                    this.score += this.totalTowerWorth;
                    this.score += this.enemyDestroyedCount;
                    this.score += this.ui.getTotalTowerCost({towerType:"base",level:1+this.baseUpgradedCount});
                },
                draw: function() {
                    this.drawBackground();

                    ctx.save();
                    ctx.translate(500-this.cam.x,500-this.cam.y);
                    this.objects.draw();
                    this.deletedObjects.draw();
                    ctx.restore();

                    this.ui.draw();
                    this.waves.draw();

                    if(this.gameOver) this.drawGameOverMenu();

                    if(this.startAnimation>0) {
                        ctx.fillStyle = 'rgba(0,0,0,'+(this.startAnimation/100)+')';
                        ctx.fillRect(0,0,1000,1000);
                    }

                    if(this.paused) this.drawPauseMenu();
                },
                drawPauseMenu: function() {
                    ctx.fillStyle = 'rgba(0,0,0,0.5)';
                    ctx.fillRect(0,0,1000,1000);

                    ctx.strokeStyle = 'black';
                    ctx.lineWidth = 3;
                    ctx.fillStyle = 'rgb(200,200,200)';
                    roundRect(200,150,600,700,20);
                    ctx.fill();
                    ctx.stroke();

                    f(90);
                    ctx.fillStyle = 'black';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText("Paused",500,250);

                    f(70);
                    ctx.strokeStyle = 'black';
                    ctx.lineWidth = 5;
                    ctx.fillStyle = 'rgb(255,255,255)';
                    roundRect(365,350,270,120,20);
                    if(Mouse.inBox(365,350,270,120)) {
                        ctx.fillStyle = 'rgb(230,230,230)';
                    }
                    ctx.fill();
                    ctx.stroke();
                    ctx.fillStyle = 'black';
                    ctx.fillText('Retry',500,420);
                    //retry button

                    ctx.strokeStyle = 'black';
                    ctx.lineWidth = 5;
                    ctx.fillStyle = 'rgb(255,255,255)';
                    roundRect(365,500,270,120,20);
                    if(Mouse.inBox(365,500,270,120)) {
                        ctx.fillStyle = 'rgb(230,230,230)';
                    }
                    ctx.fill();
                    ctx.stroke();
                    ctx.fillStyle = 'black';
                    ctx.fillText('Quit',500,570);
                    //quit button

                    ctx.strokeStyle = 'black';
                    ctx.lineWidth = 5;
                    ctx.fillStyle = 'rgb(255,255,255)';
                    roundRect(340,650,320,120,20);
                    if(Mouse.inBox(340,650,320,120)) {
                        ctx.fillStyle = 'rgb(230,230,230)';
                    }
                    ctx.fill();
                    ctx.stroke();
                    ctx.fillStyle = 'black';
                    ctx.fillText('Continue',500,720);
                    //continue button
                },
                updatePauseMenu: function() {
                    if(Mouse.inBox(365,350,270,120)) {
                        if(Mouse.click) {
                            game.reset();
                        }
                    }
                    //retry

                    if(Mouse.inBox(365,500,270,120)) {
                        if(Mouse.click) {
                            page = "menu";
                        }
                    }
                    //quit

                    if(Mouse.inBox(340,650,320,120)) {
                        if(Mouse.click) {
                            this.paused = false;
                        }
                    }
                    //continue
                },
                drawGameOverMenu: function() {
                    ctx.save();
                    ctx.translate(-(this.gameOverAnimation**3)/100,0);

                    ctx.strokeStyle = 'black';
                    ctx.lineWidth = 3;
                    ctx.fillStyle = 'rgb(200,200,200)';
                    roundRect(200,150,600,700,20);
                    ctx.fill();
                    ctx.stroke();

                    f(90);
                    ctx.fillStyle = 'black';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText("Game Over!",500,250);

                    f(38);
                    ctx.fillText(`You made it to wave ${this.waves.wave}.`,500,340);
                    ctx.fillText(`You destroyed ${this.enemyDestroyedCount} enem${this.enemyDestroyedCount==1?'y':'ies'}.`,500,390);
                    ctx.fillText(`You had $${this.money}.`,500,440);
                    ctx.fillText(`Your towers were worth $${this.totalTowerWorth}.`,500,490);
                    f(60);
                    ctx.fillText(`Final Score: ${this.score}`,500,580);
                    ctx.fillText(`Highscore: ${highscore}`,500,650);

                    f(70);
                    ctx.strokeStyle = 'black';
                    ctx.lineWidth = 5;
                    ctx.fillStyle = 'rgb(255,255,255)';
                    roundRect(220,710,270,120,20);
                    if(Mouse.inBox(220,710,270,120)) {
                        ctx.fillStyle = 'rgb(230,230,230)';
                    }
                    ctx.fill();
                    ctx.stroke();
                    ctx.fillStyle = 'black';
                    ctx.fillText('Retry',355,780);
                    //retry button

                    ctx.strokeStyle = 'black';
                    ctx.lineWidth = 5;
                    ctx.fillStyle = 'rgb(255,255,255)';
                    roundRect(510,710,270,120,20);
                    if(Mouse.inBox(510,710,270,120)) {
                        ctx.fillStyle = 'rgb(230,230,230)';
                    }
                    ctx.fill();
                    ctx.stroke();
                    ctx.fillStyle = 'black';
                    ctx.fillText('Quit',645,780);
                    //quit button

                    ctx.restore();
                },
                updateGameOverMenu: function() {
                    this.gameOverAnimation--;
                    this.gameOverAnimation = Math.max(0,this.gameOverAnimation);

                    if(Mouse.inBox(220,710,270,120)) {
                        if(Mouse.click) {
                            game.reset();
                        }
                    }
                    //retry

                    if(Mouse.inBox(510,710,270,120)) {
                        if(Mouse.click) {
                            page = "menu";
                        }
                    }
                    //quit
                },
                drawBackground: function() {
                    ctx.fillStyle = 'rgb(240,240,240)';
                    ctx.fillRect(0,0,1000,1000);
                    //bakckground

                    var xoff = -this.cam.x%50;
                    if(xoff<0) {
                        xoff += 50;
                    }
                    var yoff = -this.cam.y%50;
                    if(yoff<0) {
                        yoff += 50;
                    }
                    ctx.strokeStyle = 'rgb(200,200,200)';
                    ctx.lineWidth = 1;
                    for(var n=-1;n<20;n++) {
                        ctx.beginPath();
                        ctx.moveTo(n*50+xoff,0);
                        ctx.lineTo(n*50+xoff,1000);
                        ctx.stroke();
                        ctx.beginPath();
                        ctx.moveTo(0,n*50+yoff);
                        ctx.lineTo(1000,n*50+yoff);
                        ctx.stroke();
                    }
                    //grid

                    ctx.fillStyle = 'rgba(50,50,50,0.2)';
                    ctx.fillRect(-700-game.cam.x,-2000-game.cam.y,500,4000);
                    ctx.fillRect(1200-game.cam.x,-2000-game.cam.y,500,4000);
                    ctx.fillRect(-200-game.cam.x,-700-game.cam.y,1400,500);
                    ctx.fillRect(-200-game.cam.x,1200-game.cam.y,1400,500);
                    //out of bounds rectangles
                },
                ui: {
                    objectSelectedId: false,
                    uiIncorrect: [],
                    update: function() {
                        var o = game.objects.getObjectById(this.objectSelectedId);
                        if(!o) this.objectSelectedId = false;
                        if(Mouse.inBox(750,800,225,75)&&game.waves.nextWavePossible) return;
                        if(Mouse.y>900) return;
                        if(!Mouse.click) return;
                        var oldObjectSelectedId = this.objectSelectedId;
                        this.objectSelectedId = false;
                        var mouseX = Mouse.x+game.cam.x-500;
                        var mouseY = Mouse.y+game.cam.y-500;
                        for(var o of game.objects.objects) {
                            var dist = distTo(o.x,o.y,mouseX,mouseY);
                            if(o.visible===false) continue;
                            if(dist<o.r) {
                                if(o.type=="placePosition"&&o.towerPlaced) {
                                    this.objectSelectedId = o.towerPlaced;
                                } else {
                                    this.objectSelectedId = o.id;
                                }
                            }
                            if(o.type=="tower"&&game.money>=this.getUpgradeCost(o)) {
                                var dist = distTo(o.x+30,o.y-20,mouseX,mouseY);
                                if(dist<20) {
                                    this.objectSelectedId = o.id;
                                    this.UIOption("upgradeTower");
                                    this.objectSelectedId = false;
                                    if(oldObjectSelectedId==o.id) this.objectSelectedId = o.id;
                                }
                            }
                        }
                    },
                    draw: function() {
                        var o = game.objects.getObjectById(this.objectSelectedId);
                        if(o) {
                            ctx.save();
                            ctx.translate(500-game.cam.x,500-game.cam.y);
                            if(o.type=='tower') {
                                ctx.setLineDash([20,40]);
                                ctx.strokeStyle = 'black';
                                ctx.fillStyle = 'rgb(0,0,0,0.05)';
                                ctx.lineWidth = 3;
                                ctx.beginPath();
                                ctx.arc(o.x,o.y,o.range,0,2*Math.PI);
                                ctx.fill();
                                ctx.stroke();
                                ctx.setLineDash([]);
                            }

                            ctx.translate(o.x,o.y);
                            var s = (Math.sin(t/50)+1)/20;
                            ctx.scale(o.r/70+s,o.r/70+s);
                            ctx.lineWidth = 10;
                            ctx.lineCap = 'round';
                            ctx.lineJoin = 'round';
                            ctx.strokeStyle = 'black';
                            for(var n=0;n<4;n++) {
                                ctx.beginPath();
                                ctx.moveTo(-100,-50);
                                ctx.lineTo(-100,-100);
                                ctx.lineTo(-50,-100);
                                ctx.stroke();
                                ctx.rotate(Math.PI/2);
                            }
                            //object select

                            ctx.restore();
                        }

                        if(o.type=="tower") {
                            this.drawTowerStats(o);
                        }
                        if(o.type=="enemy") {
                            this.drawEnemyStats(o);
                        }
                        if(o.type=="base") {
                            this.drawBaseStats(o);
                        }

                        f(50);
                        ctx.fillStyle = 'black';
                        ctx.textAlign = 'right';
                        ctx.textBaseline = 'alphabetic';
                        ctx.fillText("$"+game.money,990,50);
                        ctx.fillText("Score: "+game.score,990,100);
                        //money and score

                        var enemyCount = 0;
                        for(var o2 of game.objects.objects) {
                            if(o2.type=="enemy") enemyCount++;
                        }
                        ctx.textAlign = 'left';
                        ctx.textBaseline = 'alphabetic';
                        ctx.fillText("Wave: "+game.waves.wave,160,50);
                        ctx.fillText("Enemies Left: "+enemyCount,160,100);
                        //wave and enemies left

                        ctx.fillStyle = 'rgb(240,240,240)';
                        ctx.fillRect(0,0,150,150);
                        ctx.fillStyle = 'rgb(50,50,50,0.2)';
                        ctx.fillRect(0,0,150,150);
                        ctx.fillStyle = 'rgb(240,240,240)';
                        ctx.fillRect(20,20,110,110);
                        ctx.strokeStyle = 'black';
                        ctx.lineWidth = 3;
                        ctx.strokeRect(0,0,150,150);
                        ctx.fillStyle = 'rgb(0,0,150)';
                        drawPolygon(75,75,8,5,0);
                        if(!game.gameOver) ctx.fill();
                        ctx.beginPath();
                        ctx.rect(0,0,150,150);
                        ctx.save();
                        ctx.clip();
                        for(var o2 of game.objects.objects) {
                            if(o2.type=='enemy') {
                                ctx.fillStyle = 'red';
                                ctx.fillRect(o2.x*0.075+74,o2.y*0.075+74,2,2);
                            }
                            if(o2.type=='tower') {
                                ctx.fillStyle = 'blue';
                                ctx.fillRect(o2.x*0.075+74,o2.y*0.075+74,2,2);
                            }
                        }
                        ctx.restore();
                        //map

                        ctx.fillStyle = "rgb(220,220,220)";
                        ctx.fillRect(0,900,1000,100);
                        //ui menu bar

                        if(game.gameOver) {
                            ctx.fillStyle = "black";
                            f(50);
                            ctx.textAlign = "left";
                            ctx.textBaseline = "center";
                            ctx.fillText("Game Over!",20,965);
                        }
                        //game over text

                        var options = this.getOptionsForSelectedObject(o);
                        if(game.gameOver) options = [];
                        var valid = options.map(this.validateUIOption);
                        var optionText = "";
                        for(var n=0;n<options.length;n++) {
                            ctx.save();
                            ctx.translate(n*90+50,950);
                            if(this.uiIncorrect[n]!==undefined) {
                                this.uiIncorrect[n]--;
                                if(this.uiIncorrect[n]==0) {
                                    this.uiIncorrect[n] = undefined;
                                }
                                ctx.rotate((Math.random()*this.uiIncorrect[n]-this.uiIncorrect[n]/2)*Math.PI/180);
                            }
                            ctx.strokeStyle = 'black';
                            ctx.lineWidth = 3;
                            ctx.fillStyle = "rgb(220,220,220)";
                            if(Mouse.inBox(n*90+15,915,70,70)) {
                                ctx.fillStyle = "rgb(200,200,200)";
                                if(Mouse.click) {
                                    if(valid[n]) {
                                        this.UIOption(options[n]);
                                    } else {
                                        this.uiIncorrect[n] = 40;
                                    }
                                }
                                optionText = this.getNameForUIOption(options[n]);
                            }
                            roundRect(-35,-35,70,70,10);
                            ctx.fill();
                            ctx.stroke();
                            this.drawUIOption(options[n]);
                            ctx.restore();
                        }
                        //ui options
                        
                        f(30);
                        ctx.textAlign = 'left';
                        ctx.textBaseline = 'middle';
                        ctx.fillStyle = 'black';
                        ctx.fillText(optionText,options.length*90+15,955);
                        //hover option text
                    },
                    validateUIOption(o,data) {
                        var selected = game.objects.getObjectById(game.ui.objectSelectedId);
                        if(o=="placeBasicTower") return game.money>=game.ui.getTowerCapitalCost({towerType:"basic"});
                        if(o=="placeShotgunTower") return game.money>=game.ui.getTowerCapitalCost({towerType:"shotgun"});
                        if(o=="placeSniperTower") return game.money>=game.ui.getTowerCapitalCost({towerType:"sniper"});
                        if(o=="upgradeTower") return game.money>=game.ui.getUpgradeCost(selected);
                        if(o=="deleteTower") return true;
                        if(o=="back") return true;
                        if(o=="quit") return true;
                        if(o=="pause") return true;
                        if(o=="buyPlacePosition") return game.money>=selected.cost;
                    },
                    UIOption: function(o) {
                        if(o=="back") {
                            this.objectSelectedId = false;
                        }
                        if(o=="quit") {
                            page = "menu";
                        }
                        if(o=="pause") {
                            game.paused = true;
                        }
                        if(o=="placeBasicTower") {
                            var selected = game.objects.getObjectById(this.objectSelectedId);
                            var tower = {type:'tower',towerType:'basic',x:selected.x,y:selected.y,reload:0,range:400,reloadReset:100,dir:0,turnSpeed:5,r:20,level:1};
                            game.money -= this.getTowerCapitalCost(tower);
                            game.objects.objects.push(tower);
                            this.objectSelectedId = false;
                            game.objects._updatePlacePositions = true;
                        }
                        if(o=="placeShotgunTower") {
                            var selected = game.objects.getObjectById(this.objectSelectedId);
                            var tower = {type:'tower',towerType:'shotgun',x:selected.x,y:selected.y,reload:0,range:300,reloadReset:150,dir:0,turnSpeed:3,r:20,level:1};
                            game.money -= this.getTowerCapitalCost(tower);
                            game.objects.objects.push(tower);
                            this.objectSelectedId = false;
                            game.objects._updatePlacePositions = true;
                        }
                        if(o=="placeSniperTower") {
                            var selected = game.objects.getObjectById(this.objectSelectedId);
                            var tower = {type:'tower',towerType:'sniper',x:selected.x,y:selected.y,reload:0,range:600,reloadReset:110,dir:0,turnSpeed:6,r:20,level:1};
                            game.money -= this.getTowerCapitalCost(tower);
                            game.objects.objects.push(tower);
                            this.objectSelectedId = false;
                            game.objects._updatePlacePositions = true;
                        }
                        if(o=="deleteTower") {
                            var tower = game.objects.getObjectById(this.objectSelectedId);
                            var cost = this.getTowerSellCost(tower);
                            game.money += cost;
                            tower.delete = true;
                            this.objectSelectedId = false;
                            game.objects._updatePlacePositions = true;
                        }
                        if(o=="upgradeTower") {
                            game.money -= game.ui.getUpgradeCost(game.objects.getObjectById(this.objectSelectedId));
                            var tower = game.objects.getObjectById(this.objectSelectedId);
                            if(tower.towerType=="base") {
                                game.baseUpgradedCount++;
                                tower.health += 200;
                                tower.maxHealth += 200;
                                tower.health = Math.round(tower.health);
                                tower.maxHealth = Math.round(tower.maxHealth);
                                tower.healRate += 0.01;
                                tower.healRate = Math.round(tower.healRate*100)/100;
                                tower.level++;
                                return;
                            }
                            tower.reloadReset *= 0.95;
                            tower.reloadReset = Math.round(tower.reloadReset);
                            tower.range *= 1.03;
                            tower.level++;
                            tower.upgraded = 100;
                        }
                        if(o=="buyPlacePosition") {
                            var selected = game.objects.getObjectById(this.objectSelectedId);
                            game.money -= selected.cost;
                            selected.bought = true;
                        }
                    },
                    getUpgradeCost: function(o) {
                        if(o.towerType=="basic") return 2+o.level;
                        if(o.towerType=="sniper") return 3+o.level*2;
                        if(o.towerType=="shotgun") return o.level*5;
                        if(o.towerType=="base") return o.level*10+5;
                    },
                    drawTowerStats: function(o) {
                        var texts = [];
                        var towerName = "Basic";
                        if(o.towerType=="shotgun") towerName = "Shotgun";
                        if(o.towerType=="sniper") towerName = "Sniper";
                        texts.push("Range: "+Math.round(o.range));
                        texts.push("Damage: "+game.objects.getBulletDamage(o)*game.objects.getBulletNum(o));
                        texts.push("Reload: "+Math.round(o.reloadReset));
                        texts.push("");
                        texts.push("Level "+o.level);
                        texts.push(towerName+" Turret");
                        this.drawStats(texts);
                    },
                    drawEnemyStats: function(o) {
                        var texts = [];
                        texts.push("Health: "+Math.round(o.health)+"/"+Math.round(o.maxHealth));
                        this.drawStats(texts);
                    },
                    drawBaseStats: function(o) {
                        var texts = [];
                        texts.push("Health: "+Math.round(o.health)+"/"+Math.round(o.maxHealth));
                        texts.push("Heal Rate: "+Math.round(o.healRate*100)+"/sec");
                        texts.push("");
                        texts.push("Level "+o.level);
                        texts.push("Base");
                        this.drawStats(texts);
                    },
                    drawStats: function(stats) {
                        f(25);
                        var maxWidth = 0;
                        for(var stat of stats) {
                            maxWidth = Math.max(ctx.measureText(stat).width,maxWidth);
                        }
                        ctx.fillStyle = "rgb(200,200,200)";
                        ctx.fillRect(0,880-stats.length*30,maxWidth+40,stats.length*30+20);
                        ctx.fillStyle = 'black';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'alphabetic';
                        for(var n in stats) {
                            var stat = stats[n];
                            ctx.fillText(stat,maxWidth/2+20,885-n*30);
                        }
                    },
                    getNameForUIOption: function(o) {
                        var id = game.ui.objectSelectedId;
                        if(o=="quit") return "Quit";
                        if(o=="pause") return "Pause";
                        if(o=="back") return "Deselect";
                        if(o=="placeBasicTower") return "Build Basic Turret";
                        if(o=="placeShotgunTower") return "Build Shotgun Turret";
                        if(o=="placeSniperTower") return "Build Sniper Turret";
                        if(o=="upgradeTower"&&id!="base1") return "Upgrade Turret";
                        if(o=="upgradeTower"&&id=="base1") return "Upgrade Base";
                        if(o=="deleteTower") return "Sell Turret";
                        if(o=="buyPlacePosition") return "Buy Plot";
                        return "";
                    },
                    drawUIOption: function(type) {
                        var o = game.objects.getObjectById(game.ui.objectSelectedId);
                        if(type=="placeBasicTower"||type=="placeShotgunTower"||type=="placeSniperTower") {
                            var towerType = type.split("place")[1].split("Tower")[0].toLowerCase();
                            var tower = {};
                            tower.r = 20;
                            tower.type = "tower";
                            tower.towerType = towerType;
                            tower.x = 0;
                            tower.y = -7;
                            tower.dir = 0;
                            game.objects.drawObject(tower);
                            ctx.fillStyle = "black";
                            var cost = game.ui.getTowerCapitalCost(tower);
                            if(game.money<cost) ctx.fillStyle = "rgb(200,0,0)";
                            ctx.textAlign = "center";
                            ctx.textBaseline = "alphabetic";
                            f(20);
                            ctx.fillText("$"+cost,0,30);
                            ctx.fillStyle = 'rgba(255,255,255,0.5)';
                            ctx.fillRect(-33,-14,66,24);
                            ctx.fillStyle = 'black';
                            ctx.textBaseline = "middle";
                            f(13);
                            ctx.fillText(towerType.toUpperCase(),0,0);
                        }
                        if(type=="deleteTower") {
                            ctx.strokeStyle = "red";
                            ctx.lineWidth = 5;
                            ctx.lineCap = "round";
                            ctx.beginPath();
                            ctx.moveTo(-15,-20);
                            ctx.lineTo(15,10);
                            ctx.moveTo(15,-20);
                            ctx.lineTo(-15,10);
                            ctx.stroke();
                            ctx.fillStyle = 'black';
                            ctx.textAlign = "center";
                            ctx.textBaseline = "alphabetic";
                            f(20);
                            var cost = this.getTowerSellCost(o);
                            ctx.fillText("+$"+cost,0,30);
                        }
                        if(type=="upgradeTower") {
                            ctx.fillStyle = "lime";
                            ctx.fillRect(-7.5,-10,15,20);
                            ctx.beginPath();
                            ctx.moveTo(0,-20);
                            ctx.lineTo(20,0);
                            ctx.lineTo(-20,0);
                            ctx.closePath();
                            ctx.fill();
                            var selected = game.objects.getObjectById(this.objectSelectedId);
                            var cost = game.ui.getUpgradeCost(selected);
                            ctx.fillStyle = "black";
                            if(game.money<cost) ctx.fillStyle = "rgb(200,0,0)";
                            ctx.textAlign = "center";
                            ctx.textBaseline = "alphabetic";
                            f(20);
                            ctx.fillText("$"+cost,0,30);
                        }
                        if(type=="back"||type=="quit") {
                            ctx.fillStyle = "black";
                            ctx.fillRect(-10,-7.5,30,15);
                            ctx.beginPath();
                            ctx.moveTo(-20,0);
                            ctx.lineTo(0,20);
                            ctx.lineTo(0,-20);
                            ctx.closePath();
                            ctx.fill();
                        }
                        if(type=="pause") {
                            ctx.fillStyle = "black";
                            ctx.fillRect(-15,-20,10,40);
                            ctx.fillRect(5,-20,10,40);
                        }
                        if(type=="buyPlacePosition") {
                            var selected = game.objects.getObjectById(this.objectSelectedId);
                            var cost = selected.cost;
                            ctx.fillStyle = "black";
                            ctx.textAlign = "center";
                            ctx.textBaseline = "middle";
                            f(30);
                            ctx.fillText("Buy",0,0);
                            ctx.textBaseline = "alphabetic";
                            f(20);
                            if(game.money<cost) ctx.fillStyle = "red";
                            ctx.fillText("$"+cost,0,30);
                        }
                    },
                    getOptionsForSelectedObject: function(o) {
                        if(o.type=='enemy') return [
                            "back"
                        ];
                        if(o.type=='base') return [
                            "back",
                            "upgradeTower"
                        ];
                        if(o.type=='tower') return [
                            "back","upgradeTower","deleteTower"
                        ];
                        if(o.type=='placePosition'&&o.bought) return [
                            "back","placeBasicTower","placeSniperTower","placeShotgunTower"
                        ];
                        if(o.type=='placePosition'&&!o.bought) return [
                            "back","buyPlacePosition"
                        ];
                        if(o===false) return [
                            "quit","pause"
                        ];
                        return [];
                    },
                    getTowerCapitalCost: function(o) {
                        if(o.towerType=="base") return 0;
                        
                        var capital;
                        if(o.towerType=="basic") capital = 10;
                        if(o.towerType=="sniper") capital = 20;
                        if(o.towerType=="shotgun") capital = 30;
                        var count = 0;
                        for(var o2 of game.objects.objects) {
                            if(o2.type=="tower"&&o2.towerType==o.towerType) count++;
                        }
                        return Math.round(capital*(1+count*0.2));
                    },
                    getTowerSellCost: function(o) {
                        return Math.floor(this.getTotalTowerCost(o)*0.75);
                    },
                    getTotalTowerCost: function(o) {
                        var capital = this.getTowerCapitalCost(o);
                        var upgradeCost = 0;
                        for(var n=1;n<o.level;n++) {
                            if(o.towerType=="basic") upgradeCost += 2+n;
                            if(o.towerType=="sniper") upgradeCost += 3+n*2;
                            if(o.towerType=="shotgun") upgradeCost += 5*n;
                            if(o.towerType=="base") upgradeCost += 10*n+5;
                        }
                        return capital+upgradeCost;
                    }
                },
                deletedObjects: {
                    objects: [],
                    update: function() {
                        for(var n=0;n < this.objects.length;n++) {
                            var o = this.objects[n];
                            o.r++;
                            o.dir += 3;
                            o.decay -= 0.03;
                            if(o.decay<=0) {
                                this.objects.splice(n,1);
                                n--;
                            }
                        }
                    },
                    draw: function() {
                        var n = 0;
                        while(n < this.objects.length) {
                            var o = this.objects[n];
                            ctx.save();
                            ctx.globalAlpha = o.decay;
                            game.objects.drawObject(o);
                            ctx.restore();
                            n++;
                        }
                    },
                    createObject: function(o) {
                        if(o.type=='bullet') return;
                        o.health = 1;
                        o.maxHealth = 1;
                        o.decay = 1;
                        this.objects.push(o);
                    }
                },
                objects: {
                    objects: [],
                    enemyIds: [],
                    base: false,
                    _updatePlacePositionsNext: false,
                    update: function(speed) {
                        var types = {};
                        this.enemyIds = [];
                        for(var n in this.objects) {
                            if(this.objects[n].type=="enemy") {
                                this.enemyIds.push(n);
                            }
                            if(this.objects[n].type=="base") {
                                this.base = this.objects[n];
                            }
                        }
                        for(var n in this.objects) {
                            var o = this.objects[n];
                            if(!types[o.type]) types[o.type] = 0;
                            types[o.type]++;
                            if(o.type!='enemy') {
                                o.id = o.type+types[o.type];
                            }
                            this.updateObject(o,speed);
                        }
                        for(var n=0;n < this.objects.length;n++) {
                            var o = this.objects[n];
                            if(o.delete) {
                                game.deletedObjects.createObject(o);
                                this.objects.splice(n,1);
                                n--;
                            }
                        }
                        this.objects.sort(function(a,b){
                            return ["placePosition","bullet","enemy","tower","base"].indexOf(a.type)-["placePosition","bullet","enemy","tower","base"].indexOf(b.type);
                        });
                        if(this._updatePlacePositions) {
                            this._updatePlacePositions = false;
                            this.updatePlacePositions();
                        }
                    },
                    draw: function() {
                        for(var o of this.objects) {
                            if(o.visible!==false) this.drawObject(o);
                        }
                    },
                    count: function(type) {
                        var count = 0;
                        for(var o of this.objects) {
                            if(o.type!==type) continue;
                            count++;
                        }
                        return count;
                    },
                    updateObject: function(o,speed) {
                        if(o.type=='bullet') {
                            this.updateBullet(o,speed);
                        } else if(o.type=='tower'&&!game.gameOver) {
                            this.updateTower(o,speed);
                        } else if(o.type=='enemy') {
                            this.updateEnemy(o,speed);
                        } else if(o.type=='base') {
                            o.health += o.healRate;
                            o.health = Math.min(o.health,o.maxHealth);
                            if(o.health<=0) {
                                o.delete = true;
                            }
                        } else if(o.type=="placePosition") {
                            o.towerPlaced = false;
                            for(var n=0;n<this.objects.length;n++) {
                                var o2 = this.objects[n];
                                if(o2.type!=='tower') continue;
                                if(o2.x!=o.x||o2.y!=o.y) continue;
                                o.towerPlaced = o2.id;
                            }
                        } else if(o.type=="moneyText") {
                            o.y--;
                            o.alpha -= 0.02;
                            if(o.alpha<=0) o.delete = true;
                        }
                    },
                    updatePlacePositions: function() {
                        var placePositionIds = [];
                        for(var n in this.objects) {
                            if(this.objects[n].type=="placePosition") placePositionIds.push(n);
                        }
                        for(var id of placePositionIds) {
                            var o = this.objects[id];
                            if(o.bought) {
                                o.visible = true;
                                continue;
                            }
                            o.visible = false;
                            for(var id2 of placePositionIds) {
                                if(id===id2) continue;
                                var o2 = this.objects[id2];
                                if(o2.towerPlaced===false) continue;
                                var dist = distTo(o.x,o.y,o2.x,o2.y);
                                if(dist<200) {
                                    o.visible = true;
                                    break;
                                }
                            }
                        }
                    },
                    updateBullet: function(o,speed) {
                        o.x += o.xmove*speed;
                        o.y += o.ymove*speed;
                        o.decay -= speed;
                        if(o.decay<=0) {
                            o.delete = true;
                        }
                        for(var id of this.enemyIds) {
                            var e = this.objects[id];
                            var dist = distTo(o.x,o.y,e.x,e.y);
                            if(dist<e.r) {
                                e.health -= o.damage;
                                o.delete = true;
                                break;
                            }
                        }
                    },
                    updateEnemy: function(o,speed) {
                        o.health = Math.min(o.health,o.maxHealth);
                        if(o.health<=0) {
                            var moneyGained = this.getMoneyFromEnemy(o)
                            game.money += moneyGained;
                            var text = {};
                            text.type = "moneyText";
                            text.amount = moneyGained;
                            text.x = o.x;
                            text.y = o.y;
                            text.alpha = 1;
                            this.objects.push(text);
                            o.delete = true;
                            game.enemyDestroyedCount++;
                        }
                        var o2 = this.base;
                        if(o2&&!game.gameOver) {
                            var dist = distTo(o.x,o.y,o2.x,o2.y);
                            if(dist<o2.r+o.r) {
                                o2.health -= o.health;
                                o.delete = true;
                                o.gainMoneyFromDestroy = false;
                            }
                        }
                        this.moveEnemy(o,speed);
                    },
                    moveEnemy: function(o,speed) {
                        var o2 = this.base;
                        if(o2&&!game.gameOver) {
                            var dir = dirTo(o.x,o.y,o2.x,o2.y);
                            o.dir = dir+70;
                            if(o.filled) o.dir = dir;
                        }
                        var move = distToMove(1,o.dir);
                        if(o.filled) move = distToMove(0.5,o.dir);
                        o.x += move[0]*speed;
                        o.y += move[1]*speed;
                        o.xmove = move[0]*speed;
                        o.ymove = move[1]*speed;
                    },
                    getMoneyFromEnemy: function(o) {
                        if(o.enemyType=="normal") return 1;
                        if(o.enemyType=="money") return 10;
                    },
                    updateTower: function(o,speed) {
                        if(o.upgraded>0) {
                            o.upgraded--;
                        }
                        if(o.reload>0) {
                            o.reload -= speed;
                        }
                        o.reload = Math.max(o.reload,0);
                        var enemiesInRange = [];
                        for(var id of this.enemyIds) {
                            var e = this.objects[id];
                            var dist = distTo(e.x,e.y,o.x,o.y);
                            if(dist<o.range) {
                                enemiesInRange.push(e);
                            }
                        }
                        var closestEnemy = false;
                        var enemyDist = Infinity;
                        for(var n in enemiesInRange) {
                            var e = enemiesInRange[n];
                            var dist = distTo(o.x,o.y,e.x,e.y);
                            if(dist<enemyDist) {
                                enemyDist = dist;
                                closestEnemy = e;
                            }
                        }
                        var bulletSpeed = 6;
                        if(o.towerType=="sniper") bulletSpeed = 11;
                        if(closestEnemy) {
                            var e = JSON.parse(JSON.stringify(closestEnemy));
                            o.target = {x:e.x,y:e.y};
                            for(var n=0;n<10;n++) {
                                e = JSON.parse(JSON.stringify(closestEnemy));
                                dist = distTo(o.x,o.y,o.target.x,o.target.y);
                                for(var n2=0;n2<dist/bulletSpeed;n2++) {
                                    this.moveEnemy(e,1);
                                }
                                o.target = {x:e.x,y:e.y};
                            }
                            var dir = dirTo(o.x,o.y,o.target.x,o.target.y);
                            var t = turn(o.dir,dir);
                            if(s(t)*o.turnSpeed<Math.abs(t)) {
                                o.dir += s(t)*o.turnSpeed*speed;
                            }
                            if(o.reload==0&&Math.abs(t)<5) {
                                var bullets = this.getTowerBullets(o);
                                this.objects = this.objects.concat(bullets);
                                o.reload = o.reloadReset;
                            }
                        }
                    },
                    getBulletSpeed: function(o) {
                        var type = o.towerType;
                        if(type=="basic") return 6;
                        if(type=="shotgun") return 7;
                        if(type=="sniper") return 11;
                    },
                    getBulletDamage: function(o) {
                        var type = o.towerType;
                        if(type=="basic") return 50+(o.level-1)*10;
                        if(type=="shotgun") return 30+(o.level-1)*7;
                        if(type=="sniper") return 150+(o.level-1)*30;
                    },
                    getBulletSpread: function(o) {
                        var type = o.towerType;
                        if(type=="basic"||type=="sniper") return 0;
                        if(type=="shotgun") return 20;
                    },
                    getBulletNum: function(o) {
                        var type = o.towerType;
                        if(type=="basic"||type=="sniper") return 1;
                        if(type=="shotgun") return 7;
                    },
                    getBulletRadius: function(o) {
                        var type = o.towerType;
                        if(type=="shotgun") return 3;
                        if(type=="sniper") return 4;
                        if(type=="basic") return 5;
                    },
                    getTowerBullets: function(o) {
                        var bullets = [];
                        var damage = this.getBulletDamage(o);
                        var speed = this.getBulletSpeed(o)-1;
                        var num = this.getBulletNum(o);
                        var spread = this.getBulletSpread(o);
                        var radius = this.getBulletRadius(o);
                        for(var n=0;n<num;n++) {
                            var bullet = {type:'bullet',from:o.towerType};
                            bullet.x = o.x;
                            bullet.y = o.y;
                            var move = distToMove(speed+Math.random()*spread/15,o.dir+Math.random()*spread-spread/2);
                            if(n==0) move = distToMove(speed,o.dir);
                            bullet.xmove = move[0];
                            bullet.ymove = move[1];
                            bullet.decay = 400;
                            bullet.damage = damage;
                            bullet.r = radius;
                            bullets.push(bullet);
                        }
                        return bullets;
                    },
                    drawObject: function(o) {
                        if(o.type=='tower') {
                            ctx.save();
                            ctx.translate(o.x,o.y);
                            ctx.rotate(o.dir*Math.PI/180);
                            ctx.scale(o.r/20,o.r/20);
                            if(o.towerType=='basic') {
                                ctx.fillStyle = 'blue';
                                drawPolygon(0,0,5,20,0);
                                ctx.fill();
                                ctx.fillStyle = 'rgb(0,0,150)';
                                drawPolygon(0,-10,5,10,0);
                                ctx.fill();
                            } else if(o.towerType=='shotgun') {
                                ctx.fillStyle = 'rgb(150,0,200)';
                                drawPolygon(0,0,6,20,0);
                                ctx.fill();
                                ctx.fillStyle = 'rgb(100,0,100)';
                                drawPolygon(0,-10,6,10,0);
                                ctx.fill();
                            } else if(o.towerType=='sniper') {
                                ctx.fillStyle = 'rgb(255,0,0)';
                                drawPolygon(0,0,3,20,0);
                                ctx.fill();
                                ctx.fillStyle = 'rgb(150,0,0)';
                                drawPolygon(0,-14,3,10,180);
                                ctx.fill();
                            }
                            ctx.restore();
                            if(o.upgraded>0) {
                                ctx.save();
                                ctx.translate(o.x,o.y-50+o.upgraded/4);
                                ctx.scale(o.upgraded/100,o.upgraded/100);
                                ctx.translate(0,10);
                                ctx.globalAlpha = o.upgraded/100;
                                ctx.fillStyle = "lime";
                                ctx.fillRect(-7.5,0,15,10);
                                ctx.beginPath();
                                ctx.moveTo(0,-20);
                                ctx.lineTo(20,0);
                                ctx.lineTo(-20,0);
                                ctx.closePath();
                                ctx.fill();
                                ctx.restore();
                            }
                            ctx.save();
                            ctx.translate(o.x+30,o.y-20);
                            var s = (Math.sin(t/30)+1)/10;
                            ctx.scale(0.5+s,0.5+s);
                            if(game.ui.getUpgradeCost(o)<=game.money) {
                                ctx.strokeStyle = "black";
                                ctx.fillStyle = "rgb(255,255,255)";
                                ctx.lineWidth = 3;
                                ctx.beginPath();
                                ctx.arc(0,-3,25,0,2*Math.PI);
                                ctx.fill();
                                ctx.stroke();
                                ctx.fillStyle = "lime";
                                ctx.fillRect(-7.5,-10,15,20);
                                ctx.beginPath();
                                ctx.moveTo(0,-20);
                                ctx.lineTo(20,0);
                                ctx.lineTo(-20,0);
                                ctx.closePath();
                                ctx.fill();
                            }
                            ctx.restore();
                        } else if(o.type=='enemy') {
                            var data = this.getEnemyData(o.enemyType);
                            ctx.strokeStyle = data.color;
                            ctx.fillStyle = data.fillColor;
                            ctx.lineWidth = 5;
                            drawPolygon(o.x,o.y,data.sides,o.r,o.dir);
                            if(o.filled||o.enemyType=="money") ctx.fill();
                            ctx.stroke();
                            if(o.enemyType=="money") {
                                ctx.strokeStyle = "black";
                                ctx.stroke();
                                ctx.fillStyle = "black";
                                ctx.textAlign = "center";
                                ctx.textBaseline = "middle";
                                f(o.r*1.5);
                                ctx.fillText("$",o.x,o.y+5);
                            }
                            if(o.health!=o.maxHealth) {
                                ctx.lineWidth = 10;
                                ctx.lineCap = 'round';
                                ctx.strokeStyle = 'rgb(50,150,50)';
                                ctx.beginPath();
                                ctx.moveTo(o.x-o.r,o.y+o.r+10);
                                ctx.lineTo(o.x+o.r,o.y+o.r+10);
                                ctx.stroke();
                                ctx.strokeStyle = 'rgb(0,255,0)';
                                ctx.beginPath();
                                ctx.moveTo(o.x-o.r,o.y+o.r+10);
                                ctx.lineTo(o.x-o.r+o.r*2*o.health/o.maxHealth,o.y+o.r+10);
                                ctx.stroke();
                                ctx.lineCap = 'square';
                            }
                            //health bar
                        } else if(o.type=='bullet') {
                            ctx.fillStyle = 'black';
                            ctx.beginPath();
                            ctx.arc(o.x,o.y,o.r,0,2*Math.PI);
                            ctx.fill();
                        } else if(o.type=='base') {
                            ctx.fillStyle = 'rgb(0,0,150)';
                            drawPolygon(o.x,o.y,8,o.r,22.6);
                            ctx.fill();
                            ctx.fillStyle = 'rgb(0,0,50)';
                            drawPolygon(o.x,o.y,4,o.r/2,45);
                            ctx.fill();
                            if(o.health!=o.maxHealth) {
                                ctx.lineWidth = 10;
                                ctx.lineCap = 'round';
                                ctx.strokeStyle = 'rgb(50,150,50)';
                                ctx.beginPath();
                                ctx.moveTo(o.x-o.r,o.y+o.r+10);
                                ctx.lineTo(o.x+o.r,o.y+o.r+10);
                                ctx.stroke();
                                ctx.strokeStyle = 'rgb(0,255,0)';
                                ctx.beginPath();
                                ctx.moveTo(o.x-o.r,o.y+o.r+10);
                                ctx.lineTo(o.x-o.r+o.r*2*o.health/o.maxHealth,o.y+o.r+10);
                                ctx.stroke();
                                ctx.lineCap = 'square';
                            }
                            //health bar
                        } else if(o.type=='placePosition') {
                            ctx.fillStyle = 'rgba(0,0,0,0.2)';
                            if(!o.bought) ctx.fillStyle = 'rgba(0,0,0,0.05)';
                            ctx.beginPath();
                            ctx.arc(o.x,o.y,25,0,2*Math.PI);
                            ctx.fill();
                            ctx.save();
                            ctx.translate(o.x,o.y);
                            var s = (Math.sin(t/30)+1)/10;
                            ctx.scale(1+s,1+s);
                            if(!o.towerPlaced&&o.bought) {
                                ctx.strokeStyle = 'black';
                                ctx.lineCap = 'round';
                                ctx.lineWidth = 3;
                                ctx.beginPath();
                                ctx.moveTo(0,-10);
                                ctx.lineTo(0,10);
                                ctx.stroke();
                                ctx.beginPath();
                                ctx.moveTo(-10,0);
                                ctx.lineTo(10,0);
                                ctx.stroke();
                            }
                            if(!o.bought) {
                                ctx.fillStyle = 'black';
                                ctx.textAlign = 'center';
                                ctx.textBasline = 'middle';
                                f(25);
                                ctx.fillText("$",0,5);
                            }
                            ctx.restore();
                        } else if(o.type=='moneyText') {
                            f(25);
                            ctx.textAlign = 'center';
                            ctx.fillStyle = 'black';
                            ctx.fillText("$"+o.amount,o.x,o.y);
                        }
                    },
                    getEnemyData: function(type) {
                        if(type=="normal") return {color:'red',fillColor:'rgb(200,0,0)',sides:3};
                        if(type=="money") return {color:'yellow',fillColor:'yellow',sides:20};
                    },
                    getObjectById: function(id) {
                        for(var o of this.objects) {
                            if(o.id==id) return o;
                        }
                        return false;
                    }
                },
                cam: {
                    x: 0,
                    y: 0,
                    target: {x:0,y:0},
                    update: function() {
                        this.x = this.x*0.98+this.target.x*0.02;
                        this.y = this.y*0.98+this.target.y*0.02;

                        if(Keys.keys[37]||Keys.keys[65]) {
                            this.target.x -= 5;
                        }
                        if(Keys.keys[38]||Keys.keys[87]) {
                            this.target.y -= 5;
                        }
                        if(Keys.keys[39]||Keys.keys[68]) {
                            this.target.x += 5;
                        }
                        if(Keys.keys[40]||Keys.keys[83]) {
                            this.target.y += 5;
                        }

                        this.target.x = Math.min(Math.max(this.target.x,-500),500);
                        this.target.y = Math.min(Math.max(this.target.y,-500),500);
                        //don't move cam out of bounds
                    }
                },
                waves: {
                    waveIntro: 0,
                    wave: 0,
                    nextWavePossible: false,
                    waveAutoStartTime: 0,
                    update: function() {
                        if(game.objects.count('enemy')==0&&this.waveIntro==0&&!this.nextWavePossible&&this.waveIntro==0) {
                            this.nextWavePossible = true;
                            this.waveAutoStartTime = 1000;
                        }
                        if(this.nextWavePossible) {
                            if(this.wave>0) this.waveAutoStartTime--;
                            if(this.waveAutoStartTime==0) {
                                this.nextWave();
                            }
                            if(Mouse.inBox(750,800,225,75)&&Mouse.click) {
                                var moneyGained = Math.max(Math.round(this.waveAutoStartTime/1000*Math.sqrt(this.wave)),1);
                                game.money += moneyGained;
                                var text = {};
                                text.type = "moneyText";
                                text.amount = moneyGained;
                                text.x = game.cam.x+400;
                                text.y = game.cam.y+300;
                                text.alpha = 1;
                                game.objects.objects.push(text);
                                this.nextWave();
                            }
                        }
                        if(this.waveIntro>0) {
                            this.waveIntro--;
                            if(this.waveIntro==0) {
                                this.generateWave();
                            }
                        }
                    },
                    draw: function() {
                        if(this.nextWavePossible&&!game.gameOver) {
                            ctx.fillStyle = 'rgb(255,255,255)';
                            if(Mouse.inBox(750,800,225,75)) {
                                ctx.fillStyle = 'rgb(230,230,230)';
                            }
                            ctx.strokeStyle = 'black';
                            ctx.lineWidth = 3;
                            roundRect(750,800,225,75,20);
                            ctx.fill();
                            ctx.stroke();
                            ctx.lineWidth = 5;
                            ctx.strokeStyle = 'red';
                            ctx.setLineDash([550*(1-this.waveAutoStartTime/1000),600]);
                            ctx.stroke();
                            ctx.setLineDash([]);

                            ctx.fillStyle = 'black';
                            f(35);
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';
                            ctx.fillText("Next Wave",863,842);
                            var moneyGained = Math.max(Math.round(this.waveAutoStartTime/1000*Math.sqrt(this.wave)),1);
                            ctx.textAlign = 'right';
                            ctx.fillText("+$"+moneyGained,735,842);
                        }

                        if(this.waveIntro==0) return;
                        if(this.waveIntro<50) {
                            ctx.globalAlpha = this.waveIntro/50;
                        }
                        if(this.waveIntro>150) {
                            ctx.globalAlpha = 1-(this.waveIntro-150)/50;
                        }
                        ctx.fillStyle = 'rgba(180,180,180,0.5)';
                        ctx.fillRect(0,400,1000,200);
                        ctx.globalAlpha = 1;
                        ctx.fillStyle = 'black';
                        var x = 0;
                        if(this.waveIntro>150) {
                            x = -((this.waveIntro-150)**1.8);
                        }
                        if(this.waveIntro<50) {
                            x = ((50-this.waveIntro)**1.8);
                        }
                        f(100);
                        ctx.save();
                        ctx.translate(x,0);
                        ctx.textAlign = "center";
                        ctx.textBaseline = "middle";
                        ctx.fillText("Wave "+this.wave,500,510);
                        ctx.restore();
                    },
                    generateWave: function() {
                        var n = 0;
                        var enemyCount = this.wave+1;
                        while(n <= enemyCount) {
                            var angle = n%10;
                            var enemiesInRing = Math.min(this.wave+2-Math.floor(n/10),10);
                            var dist = (enemyCount-n)*20+500;
                            var cor = rotate(0,0,0,-dist,angle*360/enemiesInRing);
                            var e = {type:"enemy"};
                            e.x = cor[0];
                            e.y = cor[1];
                            e.maxHealth = 150+(this.wave-1)**2;
                            e.health = e.maxHealth;
                            e.dir = 0;
                            e.id = "enemy"+n;
                            e.r = 20;
                            e.enemyType = "normal";
                            if(this.wave%10==0) {
                                e.filled = true;
                                e.x = cor[0]*1.5;
                                e.y = cor[1]*1.5;
                            }
                            if(n==0&&this.wave%5==0) {
                                e.enemyType = "money";
                            }
                            game.objects.objects.push(e);
                            n++;
                        }
                    },
                    nextWave: function() {
                        this.nextWavePossible = false;
                        this.wave++;
                        this.waveIntro = 200;
                    }
                },
                reset: function() {
                    this.paused = false;
                    this.score = 0;
                    this.baseUpgradedCount = 0;
                    this.totalTowerWorth = 0;
                    this.enemyDestroyedCount = 0;
                    this.money = 10;
                    this.speed = 1;
                    this.cam.x = 0;
                    this.cam.y = 0;
                    this.cam.target.x = 0;
                    this.cam.target.y = 0;
                    this.startAnimation = 0;
                    this.waves.wave = 0;
                    this.waves.waveIntro = 0;
                    this.waves.waveAutoStartTime = 0;
                    this.waves.nextWavePossible = false;
                    this.objects.objects = [{type:'base',towerType:'base',x:0,y:0,health:1000,maxHealth:1000,r:50,healRate:0.01,level:1}];
                    for(var n2=0;n2<4;n2++) {
                        var num = 4+Math.floor((n2+1)/2)*4;
                        for(var n=0;n<num;n++) {
                            var cors = rotate(0,0,0,-150-100*n2,n*360/num);
                            this.objects.objects.push({type:'placePosition',x:cors[0],y:cors[1],r:25,bought:n2===0,cost:15+n2*15,visible:n2===0});
                        }
                    }
                    this.ui.objectSelectedId = false;
                    this.ui.uiIncorrect = [];
                    this.gameOver = false;
                    this.gameOverMenuAnimation = 0;
                    this.objects._updatePlacePositions = true;
                },
                totalTowerWorth: 0,
                money: 10,
                speed: 1,
                enemyDestroyedCount: 0,
                gameOver: false,
                gameOverMenuAnimation: 0,
                startAnimation: 0,
                baseUpgradedCount: 0,
                score: 0
            }

            var page = 'menu';
            menu.polygons.reset();
            game.reset();
            var highscore = 0;
            if(localStorage.getItem('polygondefensehighscore')!==null) {
                highscore = localStorage.getItem('polygondefensehighscore');
            }
            function updateHighscore() {
                localStorage.setItem('polygondefensehighscore',highscore);
            }
            var t = 0;

            /*
                To Do:
                add new enemy types:
                    strong and slow
                    weak and fast
                    healing
                    stunning
                    splitting
                add new tower types
                    wind (pushes enemies away)
                    poison (good against healing)
                    lightning (good against groups)
                add final tower upgrades (level 10)
                make menu polygons reflect highscore
                add playing tutorial
                fix motion tracking for turrets (especially sniper)
            */
        </script>
    </body>
</html>
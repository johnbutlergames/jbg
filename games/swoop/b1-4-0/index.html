<!DOCTYPE HTML>
<html>
    <body>
        <canvas id="canvas"></canvas>
        <script src="https://johnbutlergames.w3spaces.com/game-setup.js"></script>
        <script src="generate-chunks.js"></script>
        <script>
            var title = "Swoop";
            var dimensions = {width:1500,height:1000};
            var images = {
                "cloud1": "images/cloud1.png",
                "cloud2": "images/cloud2.png"
            };
            var audios = {};

            initialize();
            window.setInterval(update,10);

            function main() {
                menu.tick();

                t++;
            }

            function drawPlane(a) {
                ctx.lineCap = "round";
                ctx.lineJoin = "round";

                ctx.fillStyle = "rgb(150,0,0)";
                ctx.beginPath();
                ctx.arc(-20,-2.5,7,0,2*Math.PI);
                ctx.fill();
                //rear rudder

                ctx.strokeStyle = "rgb(150,0,0)";
                ctx.lineWidth = 10;
                ctx.beginPath();
                ctx.moveTo(-20,0);
                ctx.lineTo(20,0);
                ctx.lineTo(20,10);
                ctx.quadraticCurveTo(0,7,-20,0);
                ctx.fill();
                ctx.stroke();
                //hull

                ctx.strokeStyle = "rgb(200,200,200)";
                ctx.beginPath();
                ctx.moveTo(20,0);
                ctx.lineTo(20,10);
                ctx.stroke();
                //grey plane front

                var w = Math.sin(a/3)*6;
                ctx.strokeStyle = "rgb(100,100,100)";
                ctx.lineWidth = 5;
                ctx.beginPath();
                ctx.moveTo(30,5-w);
                ctx.lineTo(30,5+w);
                ctx.stroke();
                //propeller

                ctx.beginPath();
                ctx.moveTo(15,-5);
                ctx.lineTo(20,-5);
                ctx.lineTo(20,15);
                ctx.lineTo(15,14);
                ctx.closePath();
                ctx.fill();
                //clip grey

                ctx.strokeStyle = "red";
                ctx.lineWidth = 7;
                ctx.beginPath();
                ctx.moveTo(0,2);
                ctx.lineTo(10,2);
                ctx.stroke();
                //wing

                ctx.fillStyle = "black";
                ctx.beginPath();
                ctx.arc(7,15,3,0,2*Math.PI);
                ctx.fill();
                //wheel
            }

            var menu = {
                page: "title screen",
                switchPage: "title screen",
                switchPageAnimation: 0,
                switchPageAnimationThreshold: 100,
                titleScreenAnimation: 0,
                cam: {x:-200,y:100},
                titleScreenLetters: [],
                clouds: [],
                tick: function() {
                    this.update();
                    this.draw();
                },
                update: function() {
                    if(this.page!=this.switchPage) {
                        this.switchPageAnimation++;
                        if(this.switchPageAnimation>=this.switchPageAnimationThreshold) {
                            this.page = this.switchPage;
                        }
                    } else {
                        if(this.switchPageAnimation>0) {
                            this.switchPageAnimation--;
                        }
                        if(this.switchPageAnimation<0) {
                            this.switchPageAnimation = 0;
                        }
                        this.userInteractions(this.page);
                    }
                    this.updatePage(this.page);
                },
                draw: function() {
                    this.drawPage(this.page);

                    if(this.switchPageAnimation) {
                        var a = easeInOut(this.switchPageAnimation/this.switchPageAnimationThreshold);
                        if(this.switchPage==this.page) {
                            ctx.fillStyle = "black";
                            ctx.fillRect((1-a)*1550,0,1500,1000);
                        } else {
                            ctx.fillStyle = "black";
                            ctx.fillRect(0,0,1550*a,1000);
                        }
                    }
                },
                userInteractions: function(page) {
                    if(page=="title screen") {
                        var mouseDist = distTo(Mouse.x,Mouse.y,750,540);
                        if(mouseDist<100&&Mouse.click&&this.titleScreenAnimation>375) {
                            this.switchPage = "game";
                            game.reset();
                        }
                    } else if(page=="game") {
                        game.update();
                    }
                },
                drawPage: function(page) {
                    if(page=="title screen") {
                        this.drawTitleScreenBackground();

                        ctx.save();
                        ctx.translate(750,500);
                        ctx.scale(this.cam.zoom,this.cam.zoom);
                        ctx.translate(-this.cam.x,-this.cam.y);
                        game.particles.draw();
                        this.drawTitleScreenLetters();
                        if(this.titleScreenAnimation<400) game.player.draw();
                        this.drawTitleScreenText();
                        ctx.restore();
                    } else if(page=="game") {
                        game.draw();
                    }
                },
                drawTitleScreenBackground: function() {
                    ctx.fillStyle = "rgb(171,233,242)";
                    ctx.fillRect(0,0,1500,1000);

                    for(var o of this.clouds) {
                        ctx.save();
                        ctx.translate(o.x,o.y);
                        ctx.scale(o.z,o.z);
                        ctx.drawImage(images["cloud"+o.imageNumber],-100,-50,200,100);
                        ctx.restore();
                    }
                },
                drawTitleScreenText: function() {
                    var a = this.titleScreenAnimation;

                    var s = easeInOut((a-300)/50);
                    ctx.fillStyle = "black";
                    ctx.textAlign = "center";
                    ctx.textBasline = "middle";
                    ctx.font = "bold 50px Arial";
                    ctx.save();
                    ctx.translate(0,350);
                    ctx.scale(s,s);
                    ctx.fillText("By John Butler",0,0);
                    ctx.restore();

                    var mouseDist = distTo(Mouse.x,Mouse.y,750,540);
                    var s = easeInOut((a-325)/50);
                    ctx.strokeStyle = "rgb(240,240,250)";
                    ctx.fillStyle = "white";
                    if(mouseDist<100) {
                        ctx.fillStyle = "rgb(250,250,250)";
                    }
                    ctx.lineJoin = "round";
                    ctx.lineCap = "round";
                    ctx.lineWidth = 7;
                    ctx.save();
                    ctx.translate(0,40);
                    ctx.scale(s,s);
                    ctx.beginPath();
                    ctx.arc(0,0,100,0,2*Math.PI);
                    ctx.fill();
                    ctx.stroke();
                    ctx.strokeStyle = "rgb(240,240,245)";
                    if(mouseDist<100) {
                        ctx.strokeStyle = "rgb(235,235,240)";
                    }
                    ctx.lineWidth = 15;
                    ctx.beginPath();
                    ctx.lineTo(-37,-50);
                    ctx.lineTo(53,0);
                    ctx.lineTo(-37,50);
                    ctx.closePath();
                    ctx.stroke();
                    ctx.restore();
                },
                drawTitleScreenLetters: function() {
                    var a = this.titleScreenAnimation-50;
                    for(var n=0;n<this.titleScreenLetters.length;n++) {
                        var o = this.titleScreenLetters[n];
                        ctx.save();
                        ctx.translate(o.x,o.y);
                        if(a>200) {
                            var animation = (a+n*20)%500;
                            if(animation>100) animation = 0;
                            animation /= 100;
                            var y = Math.sin(animation*Math.PI*2)*35;
                            ctx.translate(0,-y);
                        }
                        ctx.scale(o.size,o.size);
                        ctx.textAlign = "left";
                        ctx.textBaseline = "middle";
                        ctx.fillStyle = "white";
                        ctx.lineWidth = 2;
                        ctx.lineJoin = "round";
                        ctx.strokeStyle = "rgb(240,240,250)";
                        ctx.font = "bold 50px Arial";
                        ctx.fillText(o.letter,0,0);
                        ctx.strokeText(o.letter,0,0);
                        ctx.restore();
                    }
                },
                updateTitleScreenClouds: function() {
                    for(var o of this.clouds) {
                        var x = ((o.initX-this.cam.x*2.5+t*2.5)*o.z**2)/15;
                        o.x = x%1900-200;
                    }
                },
                updateTitleScreenPlane: function() {
                    var a = this.titleScreenAnimation;
                    if(a>400) return;
                    game.player.updatePosition();
                    game.player.addTrailParticles();
                    if((a>75&&a<190)||(a>=190&&a<250&&t%2==0)||(a>=250&&a<400&&t%3==0)) {
                        game.player.angle -= 1.3;
                        var _turn = turn(game.player.angle,180);
                        game.player.angle += easeInOut(_turn/200)/3;
                    } else {
                        var _turn = turn(game.player.angle,180);
                        game.player.angle += _turn/100;
                    }
                },
                spawnTitleScreenLetters: function() {
                    var a = this.titleScreenAnimation;
                    var letters = "SWOOP".split("");
                    ctx.font = "bold 150px Arial";
                    var width = ctx.measureText("SWOOP").width;
                    var x = -width/2;
                    for(var n=0;n<letters.length;n++) {
                        var letter = letters[n];
                        ctx.font = "bold 150px Arial";
                        var letterWidth = ctx.measureText(letter).width;
                        ctx.font = "bold 50px Arial";
                        var smallLetterWidth = ctx.measureText(letter).width;
                        if(a==n*35+65) {
                            var o = {};
                            o.letter = letter;
                            o.a = 20;
                            o.x = game.player.x-smallLetterWidth/2;
                            o.y = game.player.y;
                            o.originX = o.x;
                            o.originY = o.y;
                            o.targetX = x;
                            o.targetY = -250;
                            this.titleScreenLetters.push(o);
                        }
                        x += letterWidth;
                    }
                },
                updateTitleScreenLetters: function() {
                    var a = this.titleScreenAnimation;
                    for(var n=0;n<this.titleScreenLetters.length;n++) {
                        var o = this.titleScreenLetters[n];
                        o.a++;
                        o.size = easeInOut(o.a/50);
                        var moveIntoPosition = 200+n*20;
                        if(a>moveIntoPosition) {
                            var sizeAnimation = easeInOut((a-moveIntoPosition)/200);
                            var moveAnimation = easeInOut((a-moveIntoPosition)/400);
                            o.size = 1+sizeAnimation*2;
                            o.x = o.x*(1-moveAnimation)+o.targetX*moveAnimation;
                            o.y = o.y*(1-moveAnimation)+o.targetY*moveAnimation;
                        }
                    }
                },
                updateTitleScreenCam: function() {
                    var a = this.titleScreenAnimation;
                    if(a>50) {
                        this.cam.x = this.cam.x*0.95+(game.player.x*Math.max(0,1-(a-75)/175))*0.05;
                        this.cam.y = this.cam.y*0.95+(game.player.y*Math.max(0,1-(a-75)/175))*0.05;
                    } else {
                        this.cam.x = this.cam.x*0.99+(game.player.x*Math.max(0,1-(a-75)/175))*0.01;
                        this.cam.y = this.cam.y*0.99+(game.player.y*Math.max(0,1-(a-75)/175))*0.01;
                    }
                    this.cam.zoom -= Math.min(0.013,(menu.cam.zoom-1)/50);
                    this.cam.zoom = Math.max(1,this.cam.zoom);
                },
                updatePage: function(page) {
                    if(page=="title screen") {
                        this.titleScreenAnimation++;
                        var a = this.titleScreenAnimation;

                        game.particles.update();
                        this.updateTitleScreenClouds();
                        this.updateTitleScreenPlane();
                        this.updateTitleScreenCam();
                        this.spawnTitleScreenLetters();
                        this.updateTitleScreenLetters();
                    } else if(page=="game") {
                        game.updateEffects();
                    }
                },
                resetTitleScreen: function() {
                    this.page = "title screen";
                    this.switchPage = "title screen";
                    this.titleScreenAnimation = 0;
                    this.cam = {x:-150,y:210,zoom:4};
                    game.player.y = 0;
                    game.player.x = -300;
                    game.player.angle = 135;
                    game.player.drawAngle = 135;
                    for(var n=0;n<30;n++) {
                        var o = {};
                        o.imageNumber = Math.floor(Math.random()*2)+1;
                        o.z = Math.random()+1;
                        o.initX = Math.random()*15000;
                        o.x = 0;
                        o.y = Math.random()*1000;
                        this.clouds.push(o);
                    }
                }
            }

            var game = {
                coins: 0,
                started: false,
                deathTime: 0,
                screenShake: 0,
                distanceTraveled: 0,
                update: function() {
                    if(this.deathTime>=200) this.reset();
                    if(this.started) {
                        this.player.update();
                    } else {
                        if(Keys.keys[32]) {
                            this.started = true;
                        }
                    }
                    if(this.screenShake>0) {
                        this.screenShake--;
                    }
                    this.distanceTraveled = Math.round(Math.max(this.distanceTraveled,game.player.x/10));
                },
                updateEffects: function() {
                    this.cam.update();
                    this.particles.update();
                    this.objects.update();
                    this.background.update();
                },
                draw: function() {
                    this.background.draw();

                    ctx.save();
                    ctx.translate(750-this.cam.x,500-this.cam.y);

                    if(this.screenShake>0) {
                        var move = distToMove(this.screenShake,Math.random()*180+t%2*180);
                        ctx.translate(move.x,move.y);
                    }
                    this.particles.draw();
                    this.player.draw();
                    this.objects.draw();

                    ctx.restore();

                    this.drawStats();
                },
                reset: function() {
                    this.distanceTraveled = 0;
                    this.deathTime = 0;
                    this.coins = 0;
                    this.started = false;
                    this.background.reset();
                    this.particles.reset();
                    this.objects.reset();
                    this.player.reset();
                    this.cam.reset();
                },
                drawStats: function() {
                    ctx.fillStyle = "rgba(255,255,255,0.8)";
                    ctx.fillRect(0,0,1500,75);

                    ctx.fillStyle = "black";
                    ctx.font = "bold 50px Arial";
                    ctx.textAlign = "right";
                    ctx.textBaseline = "middle";
                    ctx.fillText(`Health: ${this.player.health}     Distance: ${this.distanceTraveled}     Coins: ${this.coins}`,1480,40);

                    if(t%100<50&&!this.started) {
                        ctx.fillText("Press Space to Start",750,700);
                    }
                },
                background: {
                    objects: [],
                    update: function() {
                        for(var o of this.objects) {
                            this.updateObject(o);
                        }
                    },
                    draw: function() {
                        ctx.fillStyle = "rgb(180,245,255)";
                        ctx.fillRect(0,0,1500,1000);

                        for(var o of this.objects) {
                            this.drawObject(o);
                        }
                    },
                    updateObject: function(o) {
                        if(o.type=="cloud") {
                            var x = ((o.initX-game.cam.x)*o.z**2)/15;
                            o.x = x%1900+1700;
                            o.y = o.initY-(game.cam.y*o.z**2)/15;
                        }
                    },
                    drawObject: function(o) {
                        if(o.type=="cloud") {
                            ctx.save();
                            ctx.translate(o.x,o.y);
                            ctx.scale(o.z,o.z);
                            ctx.drawImage(images["cloud"+o.imageNumber],-100,-50,200,100);
                            ctx.restore();
                        }
                    },
                    reset: function() {
                        this.objects = [];
                        for(var n=0;n<30;n++) {
                            var o = {};
                            o.type = "cloud";
                            o.imageNumber = Math.floor(Math.random()*2)+1;
                            o.z = Math.random()+1;
                            o.initX = -Math.random()*15000;
                            o.initY = Math.random()*1000;
                            o.x = 0;
                            o.y = o.initY;
                            this.objects.push(o);
                        }
                    }
                },
                player: {
                    x: 0,
                    y: 0,
                    angle: 90,
                    xmove: 0,
                    ymove: 0,
                    damping: 0.5,
                    deathDamping: 0.99,
                    speed: 2,
                    turnSpeed: 1.3,
                    drawAngle: 90,
                    dead: false,
                    health: 0,
                    maxHealth: 100,
                    update: function() {
                        if(this.dead) {
                            game.deathTime++;
                        }

                        this.updateControls();
                        this.updatePosition();
                        this.addTrailParticles();
                        this.detectCollisions();
                        if(this.health<=0) {
                            this.die();
                        }
                        if(this.health<this.maxHealth*0.5) {
                            var time = Math.round(100-(1-Math.max(0,this.health/this.maxHealth-0.25))*96);
                            if(t%time==0) {
                                this.addSmokeParticle();
                            }
                        }
                        if(this.health<this.maxHealth/3) {
                            if(t%25==0) {
                                game.particles.create({type:"plane fire particle"});
                            }
                        }
                    },
                    addSmokeParticle: function() {
                        game.particles.create({type:"plane smoke particle"});
                    },
                    addTrailParticles: function() {
                        if(t%2==0) {
                            game.particles.create({type:"plane trail particle"});
                        }
                    },
                    updatePosition: function() {
                        var move = distToMove(this.speed,this.angle);
                        if(this.dead) {
                            this.ymove += 0.1;
                        } else {
                            this.xmove += move.x;
                            this.ymove += move.y;
                        }

                        this.x += this.xmove;
                        this.y += this.ymove;
                        if(this.dead) {
                            this.xmove *= this.deathDamping;
                            this.ymove *= this.deathDamping;
                        } else {
                            this.xmove *= this.damping;
                            this.ymove *= this.damping;
                        }

                        var t = turn(this.drawAngle,this.angle);
                        this.drawAngle += t/10;
                    },
                    updateControls: function() {
                        if(Keys.keys[32]&&!this.dead) {
                            this.angle -= this.turnSpeed;
                            var _turn = turn(this.angle,180);
                            this.angle += easeInOut(_turn/200)/3;
                        } else {
                            var _turn = turn(this.angle,180);
                            this.angle += _turn/100;
                        }
                    },
                    createCircularHitbox: function() {
                        return {x:this.x,y:this.y,r:10};
                    },
                    createSquareHitbox: function() {
                        return {x:this.x-10,y:this.y-10,w:20,h:20};
                    },
                    detectCollisions: function() {
                        var angle = (this.angle-180)%360+180;
                        var circularHitbox = this.createCircularHitbox();
                        var squareHitbox = this.createSquareHitbox();
                        var topBorder = -700;
                        var bottomBorder = 700;
                        if(this.y<topBorder+circularHitbox.r) {
                            this.ymove = 0;
                            this.y = topBorder+circularHitbox.r;
                            this.normalizeAngleAgainstWall(0);
                            if(this.dead) return;
                            this.takeDamage();
                            if(angle>0) {
                                this.createCrashParticle(315);
                            } else {
                                this.createCrashParticle(225);
                            }
                        }
                        if(this.y>bottomBorder-circularHitbox.r) {
                            this.ymove = 0;
                            this.y = bottomBorder-circularHitbox.r;
                            this.normalizeAngleAgainstWall(0);
                            if(this.dead) return;
                            this.takeDamage();
                            if(angle>0) {
                                this.createCrashParticle(45);
                            } else {
                                this.createCrashParticle(135);
                            }
                        }

                        for(var o of game.objects.objects) {
                            if(o.type!="block") continue;
                            if(!blocksColliding(o.hitbox,squareHitbox)) continue;
                            var collision = this.resolveBlockCollision(o,circularHitbox);
                            if(collision) {
                                if(this.dead) return;
                                this.takeDamage();
                                this.createCrashParticle(-collision.angle+45);
                                break;
                            }
                        }
                    },
                    takeDamage: function() {
                        if(this.dead) return;
                        this.health--;
                        game.screenShake = 5;
                    },
                    createCrashParticle: function(angle) {
                        game.particles.create({angle:angle,type:"plane crash particle"});
                    },
                    normalizeAngleAgainstWall: function(angle) {
                        var left = turn(this.angle,angle-90);
                        var right = turn(this.angle,angle+90);
                        if(Math.abs(left)>Math.abs(right)) {
                            this.angle += right;
                        } else {
                            this.angle += left;
                        }
                    },
                    resolveBlockCollision: function(o,hitbox) {
                        var o = JSON.parse(JSON.stringify(o));
                        var lines = [];
                        for(var n=0;n<o.points.length;n++) {
                            var line = {};
                            var id1 = n;
                            var id2 = (n+1)%o.points.length;
                            line.point1 = {x:o.points[id1].x,y:o.points[id1].y};
                            line.point2 = {x:o.points[id2].x,y:o.points[id2].y};
                            line.point1.x += o.x;
                            line.point1.y += o.y;
                            line.point2.x += o.x;
                            line.point2.y += o.y;
                            lines.push(line);
                        }
                        for(var line of lines) {
                            var dist = distToSeg(this.x,this.y,line.point1.x,line.point1.y,line.point2.x,line.point2.y);
                            if(dist>hitbox.r) continue;
                            var collision = this.resolveLineCollision(line,hitbox,dist);
                            return collision;
                        }
                        return false;
                    },
                    resolveLineCollision: function(line,hitbox,dist) {
                        var angle = dirTo(line.point1.x,line.point1.y,line.point2.x,line.point2.y);
                        var penetration = hitbox.r-dist;
                        var p1Angle = dirTo(line.point1.x,line.point1.y,this.x,this.y);
                        var p2Angle = dirTo(this.x,this.y,line.point2.x,line.point2.y);
                        var escapeAngle;
                        var t = turn(p1Angle,p2Angle);
                        if(t>0) {
                            escapeAngle = -90;
                        } else {
                            escapeAngle = 90;
                        }
                        var move = distToMove(penetration,angle+escapeAngle);
                        this.x += move.x;
                        this.y += move.y;
                        if(this.dead) {
                            this.xmove += move.x/10;
                            this.ymove += move.y/10;
                        }
                        var speed = distTo(0,0,this.xmove,this.ymove);
                        var move = distToMove(speed,this.angle);
                        this.xmove = move.x;
                        this.ymove = move.y;
                        this.normalizeAngleAgainstWall(angle+90);
                        return {angle:-(angle+escapeAngle)};
                    },
                    draw: function() {
                        ctx.save();
                        ctx.translate(this.x,this.y);
                        ctx.rotate((-90+this.drawAngle)*Math.PI/180);

                        if(!this.dead) {
                            drawPlane(t);
                        } else {
                            drawPlane(2);
                        }

                        ctx.restore();
                    },
                    die: function() {
                        if(this.dead) return;

                        this.dead = true;
                    },
                    reset: function() {
                        this.dead = false;
                        this.x = 0;
                        this.y = 0;
                        this.angle = 90;
                        this.drawAngle = 90;
                        this.xmove = 0;
                        this.ymove = 0;
                        this.health = this.maxHealth;
                    }
                },
                objects: {
                    chunks: [],
                    chunkId: 0,
                    chunkX: 0,
                    objects: [],
                    update: function() {
                        this.updateChunks();
                        this.updateObjects();
                    },
                    updateObjects: function() {
                        for(var o of this.objects) {
                            if(o.type=="coin") {
                                var dist = distTo(o.x,o.y,game.player.x,game.player.y);
                                if(dist<75) {
                                    o.delete = true;
                                    game.particles.create({x:o.x,y:o.y,type:"coin collected particle"});
                                    game.coins++;
                                }
                            }
                        }

                        this.objects = this.objects.filter(e=>!e.delete);
                    },
                    updateChunks: function() {
                        if(game.cam.x+750>this.chunkX) this.newChunk();
                        for(var chunk of this.chunks) {
                            if(chunk.x+chunk.w<game.cam.x-1500) chunk.delete = true;
                        }
                        this.chunks = this.chunks.filter(e=>!e.delete);

                        for(var o of this.objects) {
                            if(o.delete) continue;
                            if(!o.r) o.r = 1000;
                            if(!o.hitbox) {
                                o.onScreen = o.x+o.r>game.cam.x-750&&o.x<game.cam.x+750+o.r&&o.y+o.r>game.cam.y-500&&o.y<game.cam.y+500+o.r;
                            } else {
                                var h = o.hitbox;
                                o.onScreen = h.x+h.w>game.cam.x-750&&h.x<game.cam.x+750&&h.y+h.h>game.cam.y-500&&h.y<game.cam.y+500;
                            }
                            if(!this.chunks.find(e=>e.id==o.chunkId)) o.delete = true;
                            if(o.onScreen) o.delete = false;
                        }
                    },
                    draw: function() {
                        this.drawLevelBorders();
                        for(var o of this.objects) {
                            if(!o.onScreen) continue;
                            this.drawObject(o);
                        }
                    },
                    drawLevelBorders: function() {
                        ctx.fillStyle = "black";
                        ctx.fillRect(game.cam.x-900,-900,1800,200);
                        ctx.fillRect(game.cam.x-900,700,1800,200);
                    },
                    drawObject: function(o) {
                        if(o.type=="block") {
                            ctx.save();
                            ctx.translate(o.x,o.y);
                            ctx.fillStyle = "black";
                            ctx.beginPath();
                            for(var o of o.points) {
                                ctx.lineTo(o.x,o.y);
                            }
                            ctx.closePath();
                            ctx.fill();
                            ctx.restore();
                        } else if(o.type=="coin") {
                            ctx.save();
                            ctx.translate(o.x,o.y);
                            this.drawCoin(o.x/5+t);
                            ctx.restore();
                        }
                    },
                    drawCoin: function(a) {
                        if(!a) a = t;
                        ctx.lineCap = "round";
                        ctx.fillStyle = "yellow";
                        ctx.strokeStyle = "rgb(230,230,0)";
                        ctx.lineWidth = 5;
                        ctx.beginPath();
                        ctx.lineTo(0,-25);
                        ctx.lineTo(0,25);
                        ctx.stroke();
                        ctx.scale(Math.sin(a/40),1);
                        ctx.beginPath();
                        ctx.arc(0,0,25,0,2*Math.PI);
                        ctx.fill();
                        ctx.stroke();
                        ctx.lineWidth = 10;
                        ctx.strokeStyle = "rgb(240,240,0)";
                        ctx.beginPath();
                        ctx.lineTo(0,-10);
                        ctx.lineTo(0,10);
                        ctx.stroke();
                    },
                    reset: function() {
                        this.chunks = [];
                        this.objects = [];
                        this.chunkId = 0;
                        this.chunkX = 0;
                        this.newChunk();
                    },
                    newChunk: function() {
                        var chunk = {};
                        var newChunk = this.createChunk();
                        chunk.x = this.chunkX;
                        chunk.y = 0;
                        chunk.w = newChunk.w;
                        chunk.h = 100;
                        chunk.id = this.chunkId;
                        this.chunkX += chunk.w;
                        this.chunkId++;
                        this.chunks.push(chunk);
                        var objectsToAdd = newChunk.objects;
                        this.initializeNewObjects(objectsToAdd,chunk);
                        this.objects = [...this.objects,...objectsToAdd];
                    },
                    initializeNewObjects: function(objects,chunk) {
                        for(var o of objects) {
                            o.x += chunk.x;
                            o.y += chunk.y;
                            o.w = o.w||0;
                            o.h = o.h||0;
                            o.r = o.r||1000;
                            o.chunkId = chunk.id;

                            if(o.type=="block") {
                                var hitbox = {x:0,y:0,w:0,h:0};
                                hitbox.x = Math.min(...o.points.map(e=>e.x));
                                hitbox.y = Math.min(...o.points.map(e=>e.y));
                                hitbox.w = Math.max(...o.points.map(e=>e.x))-hitbox.x;
                                hitbox.h = Math.max(...o.points.map(e=>e.y))-hitbox.y;
                                hitbox.x += o.x;
                                hitbox.y += o.y;
                                o.hitbox = hitbox;
                            }
                        }
                    },
                    createChunk: function() {
                        var generateFunction = generateFunctions[Math.floor(Math.random()*generateFunctions.length)];
                        //generateFunction = generateFunctions[3];
                        return generateFunction();
                    }
                },
                particles: {
                    particles: [],
                    update: function() {
                        for(var o of this.particles) {
                            if(o.update) o.update();
                        }
                        this.particles = this.particles.filter(e=>!e.delete);
                    },
                    draw: function() {
                        for(var o of this.particles) {
                            this.drawParticle(o);
                        }
                    },
                    drawParticle: function(o) {
                        ctx.save();
                        ctx.translate(o.x,o.y);
                        if(o.angle) ctx.rotate(o.angle*Math.PI/180);
                        if(o.alpha) ctx.globalAlpha = Math.min(Math.max(o.alpha,0),1);
                        if(o.r) ctx.scale(o.r/100,o.r/100);

                        if(o.type=="plane trail particle") {
                            ctx.beginPath();
                            ctx.fillStyle = "rgba(255,255,255,0.7)";
                            ctx.arc(0,0,5,0,2*Math.PI);
                            ctx.fill();
                        }

                        if(o.type=="coin collected particle") {
                            ctx.save();
                            game.objects.drawCoin(o.x+t);
                            ctx.restore();
                        }

                        if(o.type=="plane fire particle") {
                            ctx.beginPath();
                            ctx.fillStyle = o.color;
                            ctx.arc(0,0,10,0,2*Math.PI);
                            ctx.fill();
                        }

                        if(o.type=="plane crash particle") {
                            ctx.strokeStyle = o.color;
                            ctx.lineWidth = 3;
                            ctx.lineCap = "round";
                            ctx.beginPath();
                            ctx.moveTo(0,0);
                            ctx.lineTo(15,0);
                            ctx.stroke();
                        }

                        if(o.type=="plane smoke particle") {
                            ctx.beginPath();
                            ctx.fillStyle = "rgba(75,75,75,0.5)";
                            ctx.arc(0,0,7,0,2*Math.PI);
                            ctx.fill();
                        }

                        ctx.restore();
                    },
                    create: function(o) {
                        if(o.type=="plane trail particle") {
                            o.x = game.player.x;
                            o.y = game.player.y;
                            o.alpha = 1.5;
                            o.update = function() {
                                this.alpha -= 0.015;
                                if(this.alpha<=0) this.delete = true;
                            }
                        }
                        if(o.type=="coin collected particle") {
                            o.r = 100;
                            o.update = function() {
                                this.r -= 10;
                                if(this.r<=0) this.delete = true;

                                var targetX = game.player.x;
                                var targetY = game.player.y;
                                this.x = this.x*0.95+targetX*0.05;
                                this.y = this.y*0.95+targetY*0.05;
                            }
                        }
                        if(o.type=="plane fire particle") {
                            o.x = game.player.x;
                            o.y = game.player.y;
                            o.angle = Math.random()*360;
                            var move = distToMove(Math.random()*2+1,o.angle);
                            o.xmove = move.x/2;
                            o.ymove = move.y-2;
                            o.alpha = 0.5+Math.random()*2;
                            o.color = `rgb(255,${Math.random()*255},0)`;
                            o.update = function() {
                                this.x += this.xmove;
                                this.y += this.ymove;
                                this.xmove *= 0.995;
                                this.ymove *= 0.99;
                                this.ymove += 0.05;

                                this.alpha -= 0.02;
                                if(this.alpha<=0) this.delete = true;
                            }
                        }

                        if(o.type=="plane crash particle") {
                            o.x = game.player.x;
                            o.y = game.player.y;
                            var move = distToMove(20,game.player.drawAngle);
                            o.x += move.x;
                            o.y += move.y;

                            var move = distToMove(Math.random()*3+2,o.angle-90+Math.random()*10-5);
                            o.xmove = move.x;
                            o.ymove = move.y*2;
                            o.alpha = 0.5+Math.random()*2;
                            o.color = `rgb(255,${Math.random()*255},0)`;
                            o.update = function() {
                                this.x += this.xmove;
                                this.y += this.ymove;

                                this.alpha -= 0.05;
                                if(this.alpha<=0) this.delete = true;
                            }
                        }

                        if(o.type=="plane smoke particle") {
                            o.x = game.player.x+Math.random()*10-5;
                            o.y = game.player.y;
                            o.xmove = Math.random()*1-0.5;
                            o.alpha = 1.5+Math.random();
                            o.update = function() {
                                this.x += this.xmove;
                                this.xmove *= 0.98;
                                this.y -= 0.8;
                                this.alpha -= 0.01;
                                if(this.alpha<=0) this.delete = true;
                            }
                        }

                        this.particles.push(o);
                    },
                    reset: function() {
                        this.particles = [];
                    }
                },
                cam: {
                    x: 0,
                    y: 0,
                    update: function() {
                        var angle = game.player.angle;
                        var move = distToMove(400,angle);
                        if(move.x>0) move.x = 100;
                        if(move.x<0) move.x += 100;
                        this.x = (game.player.x+move.x+100)*0.1+this.x*0.9;
                        this.y = game.player.y*0.03+this.y*0.97;
                        this.y = Math.max(Math.min(this.y,250),-250);
                    },
                    reset: function() {
                        this.x = 0;
                        this.y = 0;
                    }
                }
            }

            var t = 0;

            menu.resetTitleScreen();
        </script>
    </body>
</html>
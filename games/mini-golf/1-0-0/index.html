<!DOCTYPE HTML>
<html>
    <body>
        <style>
            canvas {
                background-color: white;
                margin: auto;
                margin: 0;
                position: absolute;
                top: 50%;
                left: 50%;
                -ms-transform: translate(-50%,-50%);
                transform: translate(-50%,-50%);
            }
            body {
                background-color: rgb(50,50,50);
                margin: 0px;
            }
        </style>
        <canvas id='canvas'></canvas>
        <script>
            var title = 'Mini Golf';
            var dimensions = {width:1000,height:1000};
            var imgs = [];
            var audios = [];
            var canvas = document.getElementById('canvas');
            var ratio = dimensions.width/dimensions.height;
            var sizeText = 'min(100vw,100vh)';
            if(ratio>1) {
                sizeText = 'min('+(100/ratio)+'vw,100vh)';
                canvas.style.width = 'calc('+sizeText+' * '+ratio+')';
                canvas.style.height = sizeText;
            } else if(ratio<1) {
                sizeText = 'min(100vw,'+(100*ratio)+'vh)';
                canvas.style.width = sizeText;
                canvas.style.height = 'calc('+sizeText+' * '+(1/ratio)+')';
            } else {
                canvas.style.width = sizeText;
                canvas.style.height = sizeText;
            }
            canvas.width = dimensions.width;
            canvas.height = dimensions.height;
            document.title = title;
            var ctx = canvas.getContext('2d');
            canvas.onmousemove = function(event) {
                var rect = canvas.getBoundingClientRect();
                Mouse.x = (event.pageX-rect.x)*canvas.width/rect.width;
                Mouse.y = (event.pageY-rect.y)*canvas.height/rect.height;
            }
            canvas.onclick = function(event) {
                Mouse.click = true;
            }
            canvas.onmousedown = function(event) {
                Mouse.down = true;
            }
            canvas.onmouseup = function(event) {
                Mouse.down = false;
            }
            canvas.oncontextmenu = function(event) {
                event.preventDefault();
                Mouse.right = true;
            }
            canvas.onwheel = function(event) {
                Mouse.scrollX = event.deltaX;
                Mouse.scrollY = event.deltaY;
                event.preventDefault();
            }
            window.onkeydown = function(event) {
                Keys.keys[event.keyCode] = true;
                Keys.down[event.keyCode] = true;
            }
            window.onkeyup = function(event) {
                Keys.keys[event.keyCode] = false;
                Keys.up[event.keyCode] = true;
                word += String.fromCharCode(event.keyCode);
            }
            var loads = 0;
            var loaded = true;
            var intro = 0;
            var word = '';
            var n = 0;
            while(n < imgs.length) {
                var img = document.createElement('IMG');
                img.src = imgs[n];
                imgs[n] = img;
                img.onload = function() {
                    loads++;
                }
                n++;
            }
            var n = 0;
            while(n < audios.length) {
                var aud = document.createElement('AUDIO');
                aud.src = audios[n];
                audios[n] = aud;
                aud.oncanplaythrough = function() {
                    loads++;
                }
                n++;
            }
            var logoImg = document.createElement("img");
            logoImg.src = "https://johnbutlergames.w3spaces.com/logoLarge.png";
            logoImg.onload = function() {
                loads++;
            }
            var loadAnimation = 0;
            var Mouse = {
                x: 0,
                y: 0,
                down: false,
                click: false,
                scrollX: 0,
                scrollY: 0,
                inBox: function(x,y,w,h) {
                    return this.x>x&&this.x<x+w&&this.y>y&&this.y<y+h;
                },
                clickInBox: function(x,y,w,h) {
                    return this.inBox(x,y,w,h)&&this.click;
                }
            }
            var Keys = {
                keys: [],
                down: [],
                up: []
            }
            function dirTo(x1,y1,x2,y2) {
                return 90+(Math.atan2(y2-y1,x2-x1)*180/Math.PI);
            }
            function distToMove(dis,dir) {
                return [dis*Math.sin(dir*Math.PI/180),-dis*Math.cos(dir*Math.PI/180)];
            }
            function distTo(x1,y1,x2,y2) {
                return Math.sqrt(Math.pow(x1-x2,2)+Math.pow(y1-y2,2));
            }
            function inside(point, polygon) {
                let odd = false;
                for (let i = 0, j = polygon.length - 1; i < polygon.length; i++) {
                    if (((polygon[i].y > point.y) !== (polygon[j].y > point.y))
                        && (point.x < ((polygon[j].x - polygon[i].x) * (point.y - polygon[i].y) / (polygon[j].y - polygon[i].y) + polygon[i].x))) {
                        odd = !odd;
                    }
                    j = i;

                }
                return odd;
            }
            function distToSeg(x, y, x1, y1, x2, y2) {
                var A = x - x1;
                var B = y - y1;
                var C = x2 - x1;
                var D = y2 - y1;
                var dot = A * C + B * D;
                var len_sq = C * C + D * D;
                var param = -1;
                if (len_sq != 0) {
                    param = dot / len_sq;
                }
                var xx, yy;
                if (param < 0) {
                    xx = x1;
                    yy = y1;
                } else if (param > 1) {
                    xx = x2;
                    yy = y2;
                } else {
                    xx = x1 + param * C;
                    yy = y1 + param * D;
                }

                var dx = x - xx;
                var dy = y - yy;
                return Math.sqrt(dx * dx + dy * dy);
            }
            function reflect(incidenceAngle, surfaceAngle){
                var a = surfaceAngle * 2 - incidenceAngle;
                return a >= 360 ? a - 360 : a < 0 ? a + 360 : a;
            }
            function generateMaze(data) {
                if(data===undefined) {
                    data = {};
                }
                if(!data.width) {
                    data.width = 10;
                }
                if(!data.height) {
                    data.height = 10;
                }
                var blocks = [];
                var y = 0;
                while(y < data.height*2-1) {
                    blocks.push([]);
                    var x = 0;
                    while(x < data.width*2-1) {
                        blocks[y].push(0);
                        x++;
                    }
                    y++;
                }
                var pos = [1,1];
                while(true) {
                    blocks[pos[0]][pos[1]]++;
                    var cors = [[-2,0],[2,0],[0,-2],[0,2]];
                    var n = 0;
                    while(n < cors.length) {
                        var x = cors[n][0]+pos[0];
                        var y = cors[n][1]+pos[1];
                        if(x<1||x>(data.width-1)*2||y<1||y>(data.height-1)*2) {
                            cors.splice(n,1);
                        } else {
                            cors[n] = [x,y];
                            n++;
                        }
                    }
                    var needToBacktrack = true;
                    var n = 0;
                    while(n < cors.length) {
                        if(blocks[cors[n][0]][cors[n][1]]==0) {
                            needToBacktrack = false;
                            break;
                        }
                        n++;
                    }
                    var cor = false;
                    var n = 0;
                    while(n < cors.length) {
                        var b = blocks[cors[n][0]][cors[n][1]];
                        if(b>1) {
                            cors.splice(n,1);
                            n--;
                        } else if(needToBacktrack==true) {
                            var cors2 = [[-1,0],[1,0],[0,-1],[0,1]];
                            var n2 = 0;
                            while(n2 < cors2.length) {
                                var x = cors2[n2][0]+pos[0];
                                var y = cors2[n2][1]+pos[1];
                                if(blocks[x][y]===1) {
                                    cor = [cors2[n2][0]*2+pos[0],cors2[n2][1]*2+pos[1]];
                                    break;
                                }
                                n2++;
                            }
                            break;
                        } else if(needToBacktrack==false&&b==1) {
                            cors.splice(n,1);
                            n--;
                        }
                        n++;
                    }
                    var justBacktracked = false;
                    var cors2 = [[-1,0],[1,0],[0,-1],[0,1]];
                    var n2 = 0;
                    while(n2 < cors2.length) {
                        var x = cors2[n2][0]+pos[0];
                        var y = cors2[n2][1]+pos[1];
                        var x2 = cors2[n2][0]*2+pos[0];
                        var y2 = cors2[n2][1]*2+pos[1];
                        if(x2>0&&x2<blocks.length&&y2>0&&y2<blocks.length&&blocks[x][y]!==1) {
                            if(blocks[x2][y2]==2) {
                                justBacktracked = true;
                            }
                        }
                        n2++;
                    }
                    if(needToBacktrack&&!justBacktracked) {
                        blocks[pos[0]][pos[1]]++;
                    }
                    if(justBacktracked&&!needToBacktrack) {
                        blocks[pos[0]][pos[1]]--;
                    }
                    if(!needToBacktrack) {
                        if(cors.length===0) {
                            break;
                        }
                        cor = cors[Math.floor(Math.random()*cors.length)];
                    } else if(cor===false) {
                        break;
                    }
                    blocks[(pos[0]+cor[0])/2][(pos[1]+cor[1])/2]++;
                    pos = cor;
                }
                var y = 0;
                while(y < blocks.length) {
                    var x = 0;
                    while(x < blocks[y].length) {
                        if(blocks[x][y]==0) {
                            blocks[x][y] = 1;
                        } else {
                            blocks[x][y] = 0;
                        }
                        x++;
                    }
                    y++;
                }
                return blocks;
            }
            function areaOfPoly(vertices) {
                var total = 0;
                for (var i = 0, l = vertices.length; i < l; i++) {
                    var addX = vertices[i].x;
                    var addY = vertices[i == vertices.length - 1 ? 0 : i + 1].y;
                    var subX = vertices[i == vertices.length - 1 ? 0 : i + 1].x;
                    var subY = vertices[i].y;

                    total += (addX * addY * 0.5);
                    total -= (subX * subY * 0.5);
                }
                return Math.abs(total);
            }
            function f(s) {
                ctx.font = s+"px Trebuchet MS";
            }
            function roundRect(x, y, w, h, r) {
                ctx.beginPath();
                ctx.moveTo(x+r,y);
                ctx.lineTo(x+w-r,y);
                ctx.arc(x+w-r,y+r,r,1.5*Math.PI,2*Math.PI);
                ctx.lineTo(x+w,y+h-r);
                ctx.arc(x+w-r,y+h-r,r,0*Math.PI,0.5*Math.PI);
                ctx.lineTo(x+r,y+h);
                ctx.arc(x+r,y+h-r,r,0.5*Math.PI,Math.PI);
                ctx.lineTo(x,y+r);
                ctx.arc(x+r,y+r,r,Math.PI,1.5*Math.PI);
                ctx.closePath();
            }
            function update() {
                ctx.clearRect(0,0,canvas.width,canvas.height);
                var s = Math.min(dimensions.width,dimensions.height);
                var x = (dimensions.width-s)/2;
                var y = (dimensions.height-s)/2;
                if(loaded) {
                    if(intro) {
                        intro--;
                        ctx.globalAlpha = 1-Math.min(Math.max(Math.abs(intro-150)-50,0),100)/100;
                        ctx.save();
                        ctx.scale(s/500,s/500);
                        ctx.translate(x,y);
                        ctx.drawImage(logoImg,0,0,500,500);
                        ctx.restore();
                        ctx.globalAlpha = 1;
                    } else {
                        main();
                    }
                } else {
                    var percent = loads/(imgs.length+audios.length+1);
                    if(isNaN(percent)) {
                        percent = 1;
                    }
                    if(percent===1) {
                        loaded = true;
                    }
                    ctx.save();
                    ctx.scale(s/500,s/500);
                    ctx.translate(x,y);
                    ctx.textAlign = 'center';
                    ctx.font = '30px Arial';
                    ctx.fillStyle = 'black';
                    ctx.fillRect(45,270,410,15);
                    ctx.fillStyle = 'blue';
                    ctx.fillRect(47.5,272.5,405*percent,10);
                    ctx.beginPath();
                    ctx.rect(47.5,272.5,405*percent,10);
                    ctx.save();
                    ctx.clip();
                    ctx.fillStyle = 'rgb(255,100,0)';
                    var a = loadAnimation%40;
                    var n = 0;
                    while(n < 40) {
                        ctx.beginPath();
                        ctx.moveTo(n*20+a+5,272.5);
                        ctx.lineTo(n*20+a+12.5,272.5);
                        ctx.lineTo(n*20+a+7.5,282.5);
                        ctx.lineTo(n*20+a,282.5);
                        ctx.closePath();
                        ctx.fill();
                        n++;
                    }
                    ctx.restore();
                    ctx.fillStyle = 'black';
                    ctx.fillText('Loading...',250,250);
                    ctx.restore();
                    loadAnimation+=0.5;
                }
                Mouse.click = false;
                Mouse.right = false;
                Mouse.scrollX = 0;
                Mouse.scrollY = 0;
                Keys.down = [];
                Keys.up = [];
            }
            window.setInterval(update,10);

            function main() {
                if(word.endsWith('JOHNBUTLERGAMES')) {
                    game.groundColor = 'rgb(120,120,220)';
                    game.wallColor = 'rgb(50,50,200)';
                    game.hillColor = 'rgb(80,80,200)';
                }
                if(page=="game") {
                    game.tick();
                } else if(page=="menu") {
                    menu.update();
                }
                t++;
            }

            var menu = {
                update: function() {
                    ctx.fillStyle = game.groundColor;
                    ctx.fillRect(0,0,1000,1000);

                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillStyle = 'black';
                    f(120);
                    ctx.save();
                    ctx.translate(500,150);
                    ctx.rotate(Math.sin(t/100)/10);
                    ctx.fillText("Mini Golf",0,0);
                    ctx.restore();

                    f(60);
                    ctx.fillText("By John Butler",500,920);

                    ctx.strokeStyle = 'black';
                    ctx.lineWidth = 5;
                    roundRect(350,400,300,150,20);
                    ctx.fillStyle = 'white';
                    if(Mouse.inBox(350,400,300,150)) {
                        ctx.fillStyle = 'rgb(220,220,220)';
                        if(Mouse.click) {
                            page = "game";
                            game.reset(!this.tutorialComplete);
                            this.tutorialComplete = true;
                        }
                    }
                    ctx.fill();
                    ctx.stroke();
                    ctx.fillStyle = 'black';
                    ctx.fillText("Play",500,475);
                },
                tutorialComplete: false
            }

            var game = {
                won: false,
                wonAnimation: 0,
                shots: 0,
                par: 100,
                groundColor: 'rgb(120,220,120)',
                wallColor: 'rgb(0,150,0)',
                hillColor: 'rgb(80,200,80)',
                tick: function() {
                    this.update();
                    this.draw();
                },
                update: function() {
                    if(this.won) {
                        this.wonAnimation++;
                    }

                    cam.update();
                    this.objects.update();
                    this.shot.update();
                    particles.update();
                },
                draw: function() {
                    this.drawBackground();

                    ctx.save();
                    ctx.translate(500-cam.x,500-cam.y);

                    this.objects.draw();

                    particles.draw();
                    ctx.restore();

                    this.shot.draw();
                    this.drawLabels();

                    if(this.won) {
                        ctx.fillStyle = 'black';
                        ctx.globalAlpha = Math.min(Math.max(this.wonAnimation-100,0),50)/100;
                        ctx.fillRect(0,0,1000,1000);
                        ctx.globalAlpha = 1;

                        ctx.save();
                        ctx.translate(Math.min(0,500-2000/(Math.max(this.wonAnimation-100,1)/10)),0);
                        ctx.fillStyle = 'white';
                        ctx.textAlign = 'center';
                        ctx.font = f(80);
                        ctx.fillText("Hole in "+game.shots+"!",500,200);

                        f(60);
                        ctx.textBaseline = "middle";
                        ctx.strokeStyle = 'black';
                        ctx.lineWidth = 5;
                        roundRect(350,350,300,150,20);
                        ctx.fillStyle = 'white';
                        if(Mouse.inBox(350,350,300,150)) {
                            ctx.fillStyle = 'rgb(220,220,220)';
                            if(Mouse.click) {
                                page = "game";
                                game.reset();
                            }
                        }
                        ctx.fill();
                        ctx.stroke();
                        ctx.fillStyle = 'black';
                        ctx.fillText("Next",500,425);

                        roundRect(350,550,300,150,20);
                        ctx.fillStyle = 'white';
                        if(Mouse.inBox(350,550,300,150)) {
                            ctx.fillStyle = 'rgb(220,220,220)';
                            if(Mouse.click) {
                                page = "menu";
                            }
                        }
                        ctx.fill();
                        ctx.stroke();
                        ctx.fillStyle = 'black';
                        ctx.fillText("Quit",500,625);

                        ctx.restore();
                    }
                },
                drawBackground: function() {
                    ctx.fillStyle = game.wallColor;
                    ctx.fillRect(0,0,1000,1000);
                },
                drawLabels: function() {
                    ctx.fillStyle = 'black';
                    ctx.font = f(60);
                    ctx.textAlign = 'left';
                    ctx.fillText("Shots: "+this.shots,30,60);
                    
                    ctx.fillText("Par: "+this.par,400,60);
                },
                objects: {
                    objects: [],
                    update: function() {
                        var n = 0;
                        while(n < this.objects.length) {
                            var o = this.objects[n];
                            this.updateObject(o);
                            n++;
                        }
                    },
                    draw: function() {
                        var n = 0;
                        while(n < this.objects.length) {
                            var o = this.objects[n];
                            this.drawObject(o);
                            n++;
                        }
                    },
                    updateObject: function(o) {
                        if(!o.init) {
                            if(o.type=='polygon') {
                                var x = 0;
                                var y = 0;
                                var n = 0;
                                while(n < o.points.length) {
                                    var p = o.points[n];
                                    x += p.x;
                                    y += p.y;
                                    n++;
                                }
                                x /= n;
                                y /= n;
                                o.cx = x;
                                o.cy = y;
                                var n = 0;
                                var r = 0;
                                while(n < o.points.length) {
                                    var p = o.points[n];
                                    r = Math.max(r,distTo(p.x,p.y,x,y));
                                    n++;
                                }
                                o.r = r;
                            }
                            if(o.type=='ball') {
                                o.onHill = false;
                            }
                            o.init = true;
                        }
                        if(o.type=='ball') {
                            o.x += o.xmove;
                            o.y += o.ymove;
                            o.xmove *= 0.99;
                            o.ymove *= 0.99;
                            if(distTo(0,0,o.xmove,o.ymove)<0.05&&!o.onHill) {
                                o.xmove = 0;
                                o.ymove = 0;
                            }

                            if(distTo(0,0,o.xmove,o.ymove)>0) {
                                game.updateBallCollisions(o);
                            }
                            //resolve wall collisions

                            o.onHill = false;
                            o.touchingHole = false;
                            var n = 0;
                            while(n < this.objects.length) {
                                var o2 = this.objects[n];
                                if(o2.type=='hole') {
                                    var dist = distTo(o.x,o.y,o2.x,o2.y);
                                    if(dist<17+o.r/2) {
                                        o.touchingHole = true;
                                    }
                                    if(dist<17+o.r/2) {
                                        var dir = dirTo(o.x,o.y,o2.x,o2.y);
                                        var move = distToMove(10,dir);
                                        o.xmove = move[0]*0.01+o.xmove*0.99;
                                        o.ymove = move[1]*0.01+o.ymove*0.99;
                                    }
                                    if(dist<17-o.r&&distTo(0,0,o.xmove,o.ymove)<0.1&&!o.scored) {
                                        o.scored = true;
                                        o.scoredAnimation = 100;
                                    }
                                }
                                n++;
                            }
                            //check ball in hole

                            if(o.scored) {
                                if(o.scoredAnimation===1) {
                                    var n = 0;
                                    while(n < 100) {
                                        var move = distToMove(Math.random()*10-5,Math.random()*360);
                                        particles.add(o.x,o.y,move[0],move[1]-5);
                                        n++;
                                    }
                                }
                                if(game.wonAnimation<50&&game.wonAnimation>0) {
                                    var move = distToMove(Math.random()*10-5,Math.random()*360);
                                    particles.add(o.x,o.y,move[0],move[1]-5);
                                }

                                o.scoredAnimation--;
                                o.scoredAnimation = Math.max(o.scoredAnimation,0);
                                if(o.scoredAnimation==0) {
                                    game.won = true;
                                }
                            }
                        }
                    },
                    drawObject: function(o) {
                        if(o.type=='ball') {
                            if(o.scored) {
                                var w = o.scoredAnimation/100*255;
                                ctx.beginPath();
                                ctx.fillStyle = 'rgb('+w+','+w+','+w+')';
                                ctx.arc(o.x,o.y,o.r,0,2*Math.PI);
                                ctx.fill();
                            } else {
                                ctx.fillStyle = 'white';
                                ctx.beginPath();
                                ctx.arc(o.x,o.y,o.r,0,2*Math.PI);
                                ctx.fill();
                            }
                        } else if(o.type=='polygon') {
                            ctx.strokeStyle = 'black';
                            ctx.lineWidth = 3;
                            if(o.border) {
                                ctx.fillStyle = game.groundColor;
                            } else {
                                ctx.fillStyle = game.wallColor;
                            }
                            ctx.beginPath();
                            ctx.moveTo(o.points[0].x,o.points[0].y);
                            var n = 1;
                            while(n < o.points.length) {
                                var p = o.points[n];
                                ctx.lineTo(o.points[n].x,o.points[n].y);
                                n++;
                            }
                            ctx.fill();
                            ctx.stroke();
                        } else if(o.type=='hill') {
                            ctx.fillStyle = game.hillColor;
                            ctx.beginPath();
                            ctx.moveTo(o.points[0].x,o.points[0].y);
                            var ax = 0;
                            var ay = 0;
                            var n = 1;
                            while(n < o.points.length) {
                                var p = o.points[n];
                                ctx.lineTo(p.x,p.y);
                                ax += p.x;
                                ay += p.y;
                                n++;
                            }
                            ctx.closePath();
                            ctx.fill();
                            ax += o.points[0].x;
                            ay += o.points[0].y;
                            ax /= o.points.length;
                            ay /= o.points.length;

                            var dir = dirTo(0,0,o.move.x,o.move.y);
                            ctx.save();
                            ctx.translate(ax,ay);
                            ctx.rotate(dir*Math.PI/180);
                            ctx.beginPath();
                            ctx.strokeStyle = 'white';
                            ctx.lineCap = 'round';
                            ctx.lineJoin = 'round';
                            ctx.lineWidth = 3;
                            var size = distTo(0,0,o.move.x,o.move.y)*20;
                            ctx.scale(size,size);
                            ctx.moveTo(0,20);
                            ctx.lineTo(0,-20);
                            ctx.stroke();
                            ctx.moveTo(5,-15);
                            ctx.lineTo(-5,-15);
                            ctx.lineTo(0,-20);
                            ctx.closePath();
                            ctx.stroke();
                            ctx.restore();
                        } else if(o.type=='hole') {
                            ctx.fillStyle = 'black';
                            ctx.beginPath();
                            ctx.arc(o.x,o.y,17,0,2*Math.PI);
                            ctx.fill();
                        } else if(o.type=='bounce') {
                            ctx.strokeStyle = 'black';
                            ctx.lineWidth = 3;
                            ctx.fillStyle = 'rgb(255,255,0)';
                            ctx.beginPath();
                            ctx.arc(o.x,o.y,o.r,0,2*Math.PI);
                            ctx.fill();
                            ctx.stroke();
                        } else if(o.type=='text') {
                            ctx.fillStyle = 'black';
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';
                            f(40);
                            ctx.fillText(o.text,o.x,o.y);
                        }
                    }
                },
                updateBallCollisions: function(o) {
                    var hill = false;
                    var n = 0;
                    while(n < this.objects.objects.length) {
                        var o2 = this.objects.objects[n];
                        if(o2.type=='bounce') {
                            if(distTo(o.x,o.y,o2.x,o2.y)<=o.r+o2.r) {
                                var speed = distTo(0,0,o.xmove,o.ymove);
                                var dir = dirTo(o2.x,o2.y,o.x,o.y);
                                var move = distToMove(Math.min(Math.max(speed,0.5)*2,10),dir);
                                o.xmove = move[0];
                                o.ymove = move[1];
                            }
                        } else if(o2.type=='hill') {
                            if(inside(o,o2.points)) {
                                o.xmove += o2.move.x;
                                o.ymove += o2.move.y;
                                o.onHill = true;
                                hill = true;
                            }
                        }
                        n++;
                    }
                    var hit = false;
                    var n = 0;
                    while(n < this.objects.objects.length&&!hit) {
                        var o2 = this.objects.objects[n];
                        if(o2.type=='polygon') {
                            if(distTo(o.x,o.y,o2.cx,o2.cy)<=o.r+o2.r) {
                                var n2 = 0;
                                while(n2 < o2.points.length) {
                                    var point = o2.points[n2];
                                    var speed = distTo(0,0,o.xmove,o.ymove);
                                    if(distTo(o.x,o.y,point.x,point.y)<=o.r) {
                                        var dir = dirTo(point.x,point.y,o.x,o.y);
                                        var move = distToMove(speed,dir);
                                        o.xmove = move[0];
                                        o.ymove = move[1];
                                        hit++;
                                        break;
                                    }
                                    n2++;
                                }
                            }
                        }
                        n++;
                    }
                    var n = 0;
                    while(n < this.objects.objects.length&&!hit) {
                        var o2 = this.objects.objects[n];
                        if(o2.type=='polygon') {
                            if(distTo(o.x,o.y,o2.cx,o2.cy)<=o.r+o2.r) {
                                var n2 = 0;
                                while(n2 < o2.points.length-1) {
                                    var point = o2.points[n2];
                                    var speed = distTo(0,0,o.xmove,o.ymove);
                                    var nextPoint = o2.points[n2+1];
                                    var line = {x1:point.x,y1:point.y,x2:nextPoint.x,y2:nextPoint.y};
                                    if(distToSeg(o.x,o.y,line.x1,line.y1,line.x2,line.y2)<o.r) {
                                        var ballDir = dirTo(0,0,o.xmove,o.ymove);
                                        var lineDir = dirTo(line.x1,line.y1,line.x2,line.y2);
                                        var angle = reflect(ballDir,lineDir);
                                        var newMove = distToMove(speed,angle);
                                        if(o.onHill) {
                                            o.xmove = newMove[0]*0.8;
                                            o.ymove = newMove[1]*0.8;
                                            if(distTo(0,0,o.xmove,o.ymove)<0.3) {
                                                o.xmove = 0;
                                                o.ymove = 0;
                                            }
                                        } else {
                                            o.xmove = newMove[0];
                                            o.ymove = newMove[1];
                                        }
                                        hit++;
                                        break;
                                    }
                                    n2++;
                                }
                            }
                        }
                        n++;
                    }
                    if(hit) {
                        hill = false;
                        o.x += o.xmove;
                        o.y += o.ymove;
                    }
                    return hill;
                },
                shot: {
                    startX: false,
                    startY: false,
                    endX: false,
                    endY: false,
                    canShoot: false,
                    shotPower: 0,
                    update: function() {
                        var ball = false;
                        var n = 0;
                        while(n < game.objects.objects.length) {
                            var o = game.objects.objects[n];
                            if(o.type=='ball') {
                                ball = o;
                                break;
                            }
                            n++;
                        }
                        if(ball===false) return;
                        if(word.endsWith("RAGEQUIT")) {
                            word = '';
                            Mouse.x = Math.random()*3000-1000;
                            Mouse.y = Math.random()*3000-1000;
                        }
                        if(!Keys.keys[32]) {
                            this.canShoot = distTo(0,0,ball.xmove,ball.ymove)<0.2&&!ball.touchingHole;
                            if(Mouse.down) {
                                if(this.startX===false) {
                                    this.startX = Mouse.x;
                                    this.startY = Mouse.y;
                                }
                                this.endX = Mouse.x;
                                this.endY = Mouse.y;
                                this.shotDist = Math.min(distTo(this.startX,this.startY,this.endX,this.endY),700);
                            } else {
                                if(this.startX!==false) {
                                    if(this.canShoot) {
                                        var shotDir = dirTo(this.startX,this.startY,this.endX,this.endY);
                                        var move = distToMove(this.shotDist/40,shotDir);
                                        ball.xmove = move[0];
                                        ball.ymove = move[1];
                                        game.shots++;
                                    }
                                    this.startX = false;
                                    this.startY = false;
                                }
                            }
                        } else {
                            this.startX = false;
                            this.startY = false;
                        }
                    },
                    draw: function() {
                        if(this.startX===false) return;
                        var shotDir = dirTo(this.startX,this.startY,this.endX,this.endY);
                        var shotDist = this.shotDist/40;
                        var s = this.shotDist*2/3;
                        ctx.save();
                        ctx.translate(this.startX,this.startY);
                        ctx.rotate(shotDir*Math.PI/180);
                        ctx.globalAlpha = 0.95;
                        if(!this.canShoot) ctx.globalAlpha = 0.4;
                        ctx.strokeStyle = `rgb(${this.shotDist*2/3+50},${255-Math.min(Math.max(this.shotDist*2/3-255,0),205)},50)`;
                        ctx.lineWidth = shotDist*2+5;
                        ctx.lineCap = "round";
                        ctx.beginPath();
                        ctx.moveTo(0,0);
                        ctx.lineTo(0,-s);
                        ctx.moveTo(0,-s);
                        ctx.lineTo(s/7+10,-s*6/7+10);
                        ctx.moveTo(0,-s);
                        ctx.lineTo(-s/7-10,-s*6/7+10);
                        ctx.stroke();
                        ctx.restore();
                    }
                },
                generateCourse: function(tutorial) {
                    game.objects.objects = [];
                    if(tutorial) {
                        game.objects.objects = JSON.parse(JSON.stringify(this.tutorial));
                        cam.x = 0;
                        cam.y = 0;
                        game.par = 5;
                        return;
                    }
                    var x = 0;
                    var y = 0;
                    var cors = [];
                    var n = 0;
                    while(n < 20) {
                        var duplicate = false;
                        var n2 = 0;
                        while(n2 < cors.length) {
                            if(cors[n2].x==x&&cors[n2].y==y) {
                                duplicate = true;
                                break;
                            }
                            n2++;
                        }
                        if(!duplicate) {
                            cors.push({x:x,y:y,xmove:0,ymove:0});
                        }
                        if(Math.random()<0.5) {
                            x += Math.floor(Math.random()*2)*2-1;
                        } else {
                            y += Math.floor(Math.random()*2)*2-1;
                        }
                        n++;
                    }
                    var horizontal = [];
                    var vertical = [];
                    var n = 0;
                    while(n < cors.length) {
                        var c = cors[n];
                        if(Math.random()<0.1) {
                            var move = Math.random()*0.1+0.05;
                            move *= Math.random()*2-1;
                            if(Math.random()<0.5) {
                                horizontal.push([c.y,move]);
                            } else {
                                vertical.push([c.x,move]);
                            }
                        }
                        n++;
                    }
                    var n = 0;
                    while(n < cors.length) {
                        var c = cors[n];
                        var n2 = 0;
                        while(n2 < horizontal.length) {
                            var h = horizontal[n2];
                            if(h[0]==c.y) {
                                c.ymove += h[1];
                            }
                            n2++;
                        }
                        var n2 = 0;
                        while(n2 < vertical.length) {
                            var v = vertical[n2];
                            if(v[0]==c.x) {
                                c.xmove += v[1];
                            }
                            n2++;
                        }
                        n++;
                    }
                    cam.x = cors[cors.length-1].x*200+100;
                    cam.y = cors[cors.length-1].y*200+100;
                    game.objects.objects.push({type:'hole',x:cors[cors.length-1].x*200+100,y:cors[cors.length-1].y*200+100});
                    var blocks = [];
                    var b = [];
                    var n = 0;
                    while(n < cors.length) {
                        var c = cors[n];
                        var onBallOrHole = (c.x==0&&c.y==0)||(c.x==cors[cors.length-1].x&&c.y==cors[cors.length-1].y);
                        var hill = distTo(0,0,c.xmove,c.ymove)>0.05;
                        if(!onBallOrHole) {
                            if(!hill) {
                                if(Math.random()<0.1) {
                                    if(Math.random()<0.5) {
                                        game.objects.objects.push({type:'polygon',points:[{x:cors[n].x*200+50,y:cors[n].y*200+50},{x:cors[n].x*200+150,y:cors[n].y*200+50},{x:cors[n].x*200+150,y:cors[n].y*200+150},{x:cors[n].x*200+50,y:cors[n].y*200+150},{x:cors[n].x*200+50,y:cors[n].y*200+50}]});
                                    } else {
                                        game.objects.objects.push({type:'polygon',points:[{x:cors[n].x*200+100,y:cors[n].y*200+50},{x:cors[n].x*200+150,y:cors[n].y*200+100},{x:cors[n].x*200+100,y:cors[n].y*200+150},{x:cors[n].x*200+50,y:cors[n].y*200+100},{x:cors[n].x*200+100,y:cors[n].y*200+50}]});
                                    }
                                } else if(Math.random()<0.1) {
                                    game.objects.objects.push({type:'bounce',x:cors[n].x*200+100,y:cors[n].y*200+100,r:50});
                                }
                            } else {
                                var o = {};
                                o.type = 'hill';
                                o.move = {};
                                o.move.x = c.xmove;
                                o.move.y = c.ymove;
                                o.points = [];
                                o.points.push({x:c.x*200,y:c.y*200});
                                o.points.push({x:c.x*200+200,y:c.y*200});
                                o.points.push({x:c.x*200+200,y:c.y*200+200});
                                o.points.push({x:c.x*200,y:c.y*200+200});
                                game.objects.objects.unshift(o);
                            }
                        }
                        var b2 = [[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]];
                        var n2 = 0;
                        while(n2 < b2.length) {
                            b.push({x:b2[n2][0]+c.x,y:b2[n2][1]+c.y});
                            n2++;
                        }
                        n++;
                    }
                    var n = 0;
                    while(n < b.length) {
                        var b2 = b[n];
                        var n2 = n+1;
                        while(n2 < b.length) {
                            if(b[n2].x==n2.x&&b[n2].y==b.y) {
                                b.splice(n2,1);
                                n2--;
                            }
                            n2++;
                        }
                        var n2 = 0;
                        while(n2 < cors.length) {
                            var c2 = cors[n2];
                            if(b2.x==c2.x&&b2.y==c2.y) {
                                b.splice(n,1);
                                n--;
                                break;
                            }
                            n2++;
                        }
                        n++;
                    }
                    var lines = [];
                    var n = 0;
                    while(n < b.length) {
                        var n2 = 0;
                        while(n2 < cors.length) {
                            var c = cors[n2];
                            if(c.x==b[n].x-1&&c.y==b[n].y) {
                                lines.push([{x:b[n].x*200,y:b[n].y*200},{x:b[n].x*200,y:b[n].y*200+200}]);
                            }
                            if(c.x==b[n].x&&c.y==b[n].y-1) {
                                lines.push([{x:b[n].x*200,y:b[n].y*200},{x:b[n].x*200+200,y:b[n].y*200}]);
                            }
                            if(c.x==b[n].x+1&&c.y==b[n].y) {
                                lines.push([{x:b[n].x*200+200,y:b[n].y*200},{x:b[n].x*200+200,y:b[n].y*200+200}]);
                            }
                            if(c.x==b[n].x&&c.y==b[n].y+1) {
                                lines.push([{x:b[n].x*200,y:b[n].y*200+200},{x:b[n].x*200+200,y:b[n].y*200+200}]);
                            }
                            n2++;
                        }
                        n++;
                    }
                    var n = 0;
                    while(n < lines.length) {
                        var l = lines[n];
                        var n2 = n+1;
                        while(n2 < lines.length) {
                            var l2 = lines[n2];
                            if(l[0].x==l2[0].x&&l[0].y==l2[0].y&&l[1].x==l2[1].x&&l[1].y==l2[1].y) {
                                lines.splice(n2,1);
                                n2--;
                            }
                            n2++;
                        }
                        n++;
                    }
                    while(true) {
                        var combined = false;
                        var n = 0;
                        while(n < lines.length) {
                            var l = lines[n];
                            var n2 = n+1;
                            while(n2 < lines.length) {
                                var l2 = lines[n2];
                                if(l[0].x==l2[0].x&&l[0].y==l2[0].y) {
                                    l2.shift();
                                    var n3 = 0;
                                    while(n3 < l2.length) {
                                        l.unshift(l2[n3]);
                                        n3++;
                                    }
                                    lines.splice(n2,1);
                                    combined = true;
                                    break;
                                }
                                if(l[0].x==l2[l2.length-1].x&&l[0].y==l2[l2.length-1].y) {
                                    l2.pop();
                                    var n3 = 0;
                                    while(n3 < l2.length) {
                                        l.unshift(l2[n3]);
                                        n3++;
                                    }
                                    lines.splice(n2,1);
                                    combined = true;
                                    break;
                                }
                                n2++;
                            }
                            if(combined) {
                                break;
                            }
                            n++;
                        }
                        if(!combined) {
                            break;
                        }
                    }
                    var n = 0;
                    while(n < lines.length) {
                        var l = lines[n];
                        var n2 = 0;
                        while(n2 < l.length) {
                            var lastP = l[(n2-1+l.length)%l.length];
                            var p = l[n2];
                            var nextP = l[(n2+1)%l.length];
                            var slope1 = (lastP.y-p.y)/(lastP.x-p.x);
                            var slope2 = (nextP.y-p.y)/(nextP.x-p.x);
                            if(slope1==slope2||((slope1==Infinity||slope1==-Infinity)&&(slope2==Infinity||slope2==-Infinity))) {
                                l.splice(n2,1);
                                n2--;
                            }
                            n2++;
                        }
                        n++;
                    }
                    var n = 0;
                    while(n < lines.length) {
                        var l = lines[n];
                        var o = {};
                        o.type = 'polygon';
                        o.points = l;
                        o.area = areaOfPoly(l);
                        lines[n] = o;
                        n++;
                    }
                    lines.sort(function(a,b){return a.area-b.area;});
                    var n = 0;
                    while(n < lines.length) {
                        if(n==lines.length-1) {
                            lines[n].border = true;
                        }
                        game.objects.objects.unshift(lines[n]);
                        n++;
                    }
                    var n = 0;
                    while(n < blocks.length) {
                        var b = blocks[n];
                        var p = {};
                        p.type = 'polygon';
                        p.points = [];
                        p.points.push({x:b.x,y:b.y});
                        p.points.push({x:b.x+b.w,y:b.y});
                        p.points.push({x:b.x+b.w,y:b.y+b.h});
                        p.points.push({x:b.x,y:b.y+b.h});
                        game.objects.objects.push(p);
                        n++;
                    }
                    game.objects.objects.push({type:'ball',x:100,y:100,xmove:0,ymove:0,r:10});
                },
                reset: function(tutorial) {
                    this.won = false;
                    this.wonAnimation = 0;
                    this.generateCourse(tutorial);
                    this.shots = 0;
                },
                tutorial: [
                    {type:'polygon',border:true,points:[{x:-400,y:-200},{x:600,y:-200},{x:600,y:-800},{x:1700,y:-800},{x:1700,y:-500},{x:900,y:-500},{x:900,y:200},{x:-400,y:200},{x:-400,y:-200}]},
                    {type:'text',x:0,y:-100,text:'Click and drag to shoot the ball.'},
                    {type:'text',x:750,y:-200,text:'Shoot around'},
                    {type:'text',x:750,y:-150,text:'obstacles.'},
                    {type:'polygon',points:[{x:700,y:-400},{x:800,y:-400},{x:800,y:-300},{x:700,y:-300},{x:700,y:-400}]},
                    {type:'text',x:900,y:-620,text:'Press SPACE to see the hole.'},
                    {type:'text',x:900,y:-680,text:'Shoot into the hole to win.'},
                    {type:'hole',x:1600,y:-650},
                    {type:'ball',x:0,y:0,xmove:0,ymove:0,r:10}
                ]
            }

            var cam = {
                x: 0,
                y: 0,
                update: function() {
                    var n = 0;
                    while(n < game.objects.objects.length) {
                        var o = game.objects.objects[n];
                        if(Keys.keys[32]) {
                            if(o.type=='hole') {
                                this.x = this.x*0.98+o.x*0.02;
                                this.y = this.y*0.98+o.y*0.02;
                                break;
                            }
                        } else {
                            if(o.type=='ball') {
                                this.x = this.x*0.98+o.x*0.02;
                                this.y = this.y*0.98+o.y*0.02;
                                break;
                            }
                        }
                        n++;
                    }
                }
            }

            var particles = {
                particles: [],
                update: function() {
                    var n = 0;
                    while(n < this.particles.length) {
                        var p = this.particles[n];
                        p.x += p.xmove;
                        p.y += p.ymove;
                        p.ymove += 0.05;
                        p.xmove *= 0.99;
                        p.ymove *= 0.99;
                        p.alpha -= p.decay;
                        p.animation++;
                        p.angle += p.turn;
                        if(p.alpha<=0) {
                            this.particles.splice(n,1);
                        }
                        n++;
                    }
                },
                draw: function() {
                    var n = 0;
                    while(n < this.particles.length) {
                        var p = this.particles[n];
                        ctx.fillStyle = p.color;
                        ctx.save();
                        ctx.globalAlpha = p.alpha;
                        ctx.translate(p.x+p.s/2,p.y+p.s/2);
                        ctx.rotate(p.angle*Math.PI/180);
                        ctx.scale(Math.sin(p.animation/10),1);
                        ctx.fillRect(-p.s/2,-p.s/2,p.s,p.s);
                        ctx.globalAlpha = 1;
                        ctx.restore();
                        n++;
                    }
                },
                add: function(x,y,xmove,ymove) {
                    var p = {};
                    p.x = x;
                    p.y = y;
                    p.xmove = xmove;
                    p.ymove = ymove;
                    p.color = 'hsl('+(Math.random()*360)+',100%,50%)';
                    p.decay = 0.01+Math.random()*0.01;
                    p.alpha = 2;
                    p.animation = Math.random()*50;
                    p.angle = Math.random()*360;
                    p.turn = Math.random()*2-1;
                    p.s = 10+Math.random()*10;
                    this.particles.push(p);
                }
            }

            var page = "menu";
            var t = 0;

            game.reset();

            /*
            To Do:
            Change ball shooting technique
            Remove ball shot forecasting
            Create par estimator
            Add image background for grass
            Somehow make hills look better
            Add Water?
            Add Ice?
            Add Moving Blocks?
            */
        </script>
    </body>
</html>